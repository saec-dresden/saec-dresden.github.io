"use strict";var util=require("util");var hooker=require("hooker");var colors=require("colors");var _=require("lodash");_.str=require("underscore.string");_.mixin(_.str.exports());function Log(a){this.always=this;this.options=_.extend({},{color:true,verbose:false,debug:false,outStream:process.stdout,grunt:null,maxCols:null,muted:false,},a);this.hasLogged=false;this.verbose=new VerboseLog(this,true);this.notverbose=new VerboseLog(this,false);this.verbose.or=this.notverbose;this.notverbose.or=this.verbose;if(this.options.grunt){_.bindAll(this);_.bindAll(this.verbose);_.bindAll(this.notverbose)}}exports.Log=Log;function VerboseLog(a,b){this.always=a;this._isVerbose=b}util.inherits(VerboseLog,Log);VerboseLog.prototype._write=function(){if(Boolean(this.option("verbose"))!==this._isVerbose){return}return VerboseLog.super_.prototype._write.apply(this,arguments)};function makeSmartAccessor(b,a){Object.defineProperty(Log.prototype,b,{enumerable:true,configurable:true,get:function(){return a?this.always._options[b]:this.always["_"+b]},set:function(c){if(a){this.always._options[b]=c}else{this.always["_"+b]=c}},})}makeSmartAccessor("options");makeSmartAccessor("hasLogged");makeSmartAccessor("muted",true);Log.prototype.initColors=function(){if(this.option("no-color")){colors.mode="none";hooker.hook(console,"log",function(){var a=_.toArray(arguments);return hooker.filter(this,a.map(function(b){return typeof b==="string"?colors.stripColors(b):b}))})}};Log.prototype.option=function(a){if(this.options.grunt&&this.options.grunt.option){return this.options.grunt.option(a)}var b=a.match(/^no-(.+)$/);return b?!this.options[b[1]]:this.options[a]};Log.prototype._markup=function(a){a=a||"";a=a.replace(/(\s|^)_(\S|\S[\s\S]+?\S)_(?=[\s,.!?]|$)/g,"$1"+"$2".underline);a=a.replace(/(\s|^)\*(\S|\S[\s\S]+?\S)\*(?=[\s,.!?]|$)/g,"$1"+"$2".bold);return a};Log.prototype._format=function(a){a=_.toArray(a);if(a.length>0){a[0]=String(a[0])}return util.format.apply(util,a)};Log.prototype._write=function(a){if(this.muted){return}this.hasLogged=true;a=a||"";if(this.option("no-color")){a=colors.stripColors(a)}this.options.outStream.write(this._markup(a))};Log.prototype._writeln=function(a){this._write((a||"")+"\n")};Log.prototype.write=function(){this._write(this._format(arguments));return this};Log.prototype.writeln=function(){this._writeln(this._format(arguments));return this};Log.prototype.warn=function(){var a=this._format(arguments);if(arguments.length>0){this._writeln(">> ".red+_.trim(a).replace(/\n/g,"\n>> ".red))}else{this._writeln("ERROR".red)}return this};Log.prototype.error=function(){if(this.options.grunt&&this.options.grunt.fail){this.options.grunt.fail.errorcount++}this.warn.apply(this,arguments);return this};Log.prototype.ok=function(){var a=this._format(arguments);if(arguments.length>0){this._writeln(">> ".green+_.trim(a).replace(/\n/g,"\n>> ".green))}else{this._writeln("OK".green)}return this};Log.prototype.errorlns=function(){var a=this._format(arguments);this.error(this.wraptext(this.options.maxCols||77,a));return this};Log.prototype.oklns=function(){var a=this._format(arguments);this.ok(this.wraptext(this.options.maxCols||77,a));return this};Log.prototype.success=function(){var a=this._format(arguments);this._writeln(a.green);return this};Log.prototype.fail=function(){var a=this._format(arguments);this._writeln(a.red);return this};Log.prototype.header=function(){var a=this._format(arguments);if(this.hasLogged){this._writeln()}this._writeln(a.underline);return this};Log.prototype.subhead=function(){var a=this._format(arguments);if(this.hasLogged){this._writeln()}this._writeln(a.bold);return this};Log.prototype.debug=function(){var a=this._format(arguments);if(this.option("debug")){this._writeln("[D] "+a.magenta)}return this};Log.prototype.writetableln=function(b,a){this._writeln(this.table(b,a));return this};Log.prototype.writelns=function(){var a=this._format(arguments);this._writeln(this.wraptext(this.options.maxCols||80,a));return this};Log.prototype.writeflags=function(a,b){var c;if(Array.isArray(a)){c=this.wordlist(a)}else{if(typeof a==="object"&&a){c=this.wordlist(Object.keys(a).map(function(d){var e=a[d];return d+(e===true?"":"="+JSON.stringify(e))}))}}this._writeln((b||"Flags")+": "+(c||"(none)".cyan));return this};Log.prototype.wordlist=exports.wordlist=function(a,b){b=_.defaults(b||{},{separator:", ",color:"cyan"});return a.map(function(c){return b.color?String(c)[b.color]:c}).join(b.separator)};Log.prototype.uncolor=exports.uncolor=function(a){return a.replace(/\x1B\[\d+m/g,"")};Log.prototype.wraptext=exports.wraptext=function(h,f){var e=[];var d,c,g;var a=[];var b=0;while(d=f.match(/(?:(\x1B\[\d+m)|\n|(.))([\s\S]*)/)){f=d[3];if(d[1]){c=d[1];a.push(d[1]);continue}else{if(d[2]){if(b===0&&c){a.push(c)}a.push(d[2]);b++;if(b<=h||d[2]===" "){continue}g=a.lastIndexOf(" ");f=a.slice(g===-1?g:g+1).join("")+f;a=a.slice(0,g)}}e.push(a.join(""));a=[];b=0}e.push(a.join(""));return e.join("\n")};Log.prototype.table=exports.table=function(d,c){var b=[];d.forEach(function(g,e){var f=this.wraptext(g,c[e]).split("\n");f.forEach(function(i,h){var k=b[h];if(!k){k=b[h]=[]}k[e]=i})},this);var a=[];b.forEach(function(h){var j="";var e;for(var g=0;g<h.length;g++){e=h[g]||"";j+=e;var f=d[g]-this.uncolor(e).length;if(f>0){j+=_.repeat(" ",f)}}a.push(j)},this);return a.join("\n")};