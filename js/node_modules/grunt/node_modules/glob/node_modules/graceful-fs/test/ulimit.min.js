var test=require("tap").test;var fs_=require("fs");var fs=require("../graceful-fs.js");var files=fs.readdirSync(__dirname);var fds=0;var nextFd=60;var limit=8;fs_.open=function(d,b,c,a){process.nextTick(function(){++fds;if(fds>=limit){--fds;var e=new Error("EMFILE Curses!");e.code="EMFILE";e.path=d;return a(e)}else{a(null,nextFd++)}})};fs_.openSync=function(d,b,c){if(fds>=limit){var a=new Error("EMFILE Curses!");a.code="EMFILE";a.path=d;throw a}else{++fds;return nextFd++}};fs_.close=function(b,a){process.nextTick(function(){--fds;a()})};fs_.closeSync=function(a){--fds};fs_.readdir=function(b,a){process.nextTick(function(){if(fds>=limit){var c=new Error("EMFILE Curses!");c.code="EMFILE";c.path=b;return a(c)}else{++fds;process.nextTick(function(){--fds;a(null,[__filename,"some-other-file.js"])})}})};fs_.readdirSync=function(b){if(fds>=limit){var a=new Error("EMFILE Curses!");a.code="EMFILE";a.path=b;throw a}else{return[__filename,"some-other-file.js"]}};test("open emfile autoreduce",function(g){fs.MIN_MAX_OPEN=4;g.equal(fs.MAX_OPEN,1024);var d=12;for(var c=0;c<d;c++){fs.open(__filename,"r",e(c))}var f=0;var b=[[0,60,null,1024,4,12,1],[1,61,null,1024,4,12,2],[2,62,null,1024,4,12,3],[3,63,null,1024,4,12,4],[4,64,null,1024,4,12,5],[5,65,null,1024,4,12,6],[6,66,null,1024,4,12,7],[7,67,null,6,4,5,1],[8,68,null,6,4,5,2],[9,69,null,6,4,5,3],[10,70,null,6,4,5,4],[11,71,null,6,4,5,5]];var a=[];function e(h){return function(i,j){if(i){throw i}a.push([h,j,i,fs.MAX_OPEN,fs.MIN_MAX_OPEN,fs._curOpen,fds]);if(h===d-1){g.same(a,b);g.ok(fs.MAX_OPEN<limit);g.end()}fs.close(j)}}});test("readdir emfile autoreduce",function(f){fs.MAX_OPEN=1024;var d=12;for(var c=0;c<d;c++){fs.readdir(__dirname,e(c))}var b=[[0,[__filename,"some-other-file.js"],null,7,4,7,7],[1,[__filename,"some-other-file.js"],null,7,4,7,6],[2,[__filename,"some-other-file.js"],null,7,4,7,5],[3,[__filename,"some-other-file.js"],null,7,4,7,4],[4,[__filename,"some-other-file.js"],null,7,4,7,3],[5,[__filename,"some-other-file.js"],null,7,4,6,2],[6,[__filename,"some-other-file.js"],null,7,4,5,1],[7,[__filename,"some-other-file.js"],null,7,4,4,0],[8,[__filename,"some-other-file.js"],null,7,4,3,3],[9,[__filename,"some-other-file.js"],null,7,4,2,2],[10,[__filename,"some-other-file.js"],null,7,4,1,1],[11,[__filename,"some-other-file.js"],null,7,4,0,0]];var a=[];function e(g){return function(h,i){if(h){throw h}var j=[g,i,h,fs.MAX_OPEN,fs.MIN_MAX_OPEN,fs._curOpen,fds];a.push(j);if(g===d-1){f.ok(fs.MAX_OPEN<limit);f.same(a,b);f.end()}}}});