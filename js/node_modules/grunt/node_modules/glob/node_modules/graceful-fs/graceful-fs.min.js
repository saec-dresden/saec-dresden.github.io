var fs=exports=module.exports={};fs._originalFs=require("fs");Object.getOwnPropertyNames(fs._originalFs).forEach(function(b){var a=Object.getOwnPropertyDescriptor(fs._originalFs,b);Object.defineProperty(fs,b,a)});var queue=[],constants=require("constants");fs._curOpen=0;fs.MIN_MAX_OPEN=64;fs.MAX_OPEN=1024;function OpenReq(d,b,c,a){this.path=d;this.flags=b;this.mode=c;this.cb=a}function noop(){}fs.open=gracefulOpen;function gracefulOpen(d,b,c,a){if(typeof c==="function"){a=c,c=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new OpenReq(d,b,c,a));setTimeout(flush);return}open(d,b,c,function(e,f){if(e&&e.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.open(d,b,c,a)}a(e,f)})}function open(d,b,c,a){a=a||noop;fs._curOpen++;fs._originalFs.open.call(fs,d,b,c,function(e,f){if(e){onclose()}a(e,f)})}fs.openSync=function(c,a,b){var d;d=fs._originalFs.openSync.call(fs,c,a,b);fs._curOpen++;return d};function onclose(){fs._curOpen--;flush()}function flush(){while(fs._curOpen<fs.MAX_OPEN){var a=queue.shift();if(!a){return}switch(a.constructor.name){case"OpenReq":open(a.path,a.flags||"r",a.mode||511,a.cb);break;case"ReaddirReq":readdir(a.path,a.cb);break;case"ReadFileReq":readFile(a.path,a.options,a.cb);break;case"WriteFileReq":writeFile(a.path,a.data,a.options,a.cb);break;default:throw new Error("Unknown req type: "+a.constructor.name)}}}fs.close=function(b,a){a=a||noop;fs._originalFs.close.call(fs,b,function(c){onclose();a(c)})};fs.closeSync=function(a){try{return fs._originalFs.closeSync.call(fs,a)}finally{onclose()}};fs.readdir=gracefulReaddir;function gracefulReaddir(b,a){if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReaddirReq(b,a));setTimeout(flush);return}readdir(b,function(c,d){if(c&&c.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readdir(b,a)}a(c,d)})}function readdir(b,a){a=a||noop;fs._curOpen++;fs._originalFs.readdir.call(fs,b,function(c,d){onclose();a(c,d)})}function ReaddirReq(b,a){this.path=b;this.cb=a}fs.readFile=gracefulReadFile;function gracefulReadFile(c,b,a){if(typeof b==="function"){a=b,b=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReadFileReq(c,b,a));setTimeout(flush);return}readFile(c,b,function(e,d){if(e&&e.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readFile(c,b,a)}a(e,d)})}function readFile(c,b,a){a=a||noop;fs._curOpen++;fs._originalFs.readFile.call(fs,c,b,function(e,d){onclose();a(e,d)})}function ReadFileReq(c,b,a){this.path=c;this.options=b;this.cb=a}fs.writeFile=gracefulWriteFile;function gracefulWriteFile(d,b,c,a){if(typeof c==="function"){a=c,c=null}if(typeof a!=="function"){a=noop}if(fs._curOpen>=fs.MAX_OPEN){queue.push(new WriteFileReq(d,b,c,a));setTimeout(flush);return}writeFile(d,b,c,function(e){if(e&&e.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.writeFile(d,b,c,a)}a(e)})}function writeFile(d,b,c,a){a=a||noop;fs._curOpen++;fs._originalFs.writeFile.call(fs,d,b,c,function(e){onclose();a(e)})}function WriteFileReq(d,b,c,a){this.path=d;this.data=b;this.options=c;this.cb=a}var constants=require("constants");if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){fs.lchmod=function(c,b,a){a=a||noop;fs.open(c,constants.O_WRONLY|constants.O_SYMLINK,b,function(d,e){if(d){a(d);return}fs.fchmod(e,b,function(f){fs.close(e,function(g){a(f||g)})})})};fs.lchmodSync=function(f,e){var d=fs.openSync(f,constants.O_WRONLY|constants.O_SYMLINK,e);var b,c;try{var g=fs.fchmodSync(d,e)}catch(a){b=a}try{fs.closeSync(d)}catch(a){c=a}if(b||c){throw (b||c)}return g}}if(!fs.lutimes){if(constants.hasOwnProperty("O_SYMLINK")){fs.lutimes=function(d,a,c,b){fs.open(d,constants.O_SYMLINK,function(e,f){b=b||noop;if(e){return b(e)}fs.futimes(f,a,c,function(g){fs.close(f,function(h){return b(g||h)})})})};fs.lutimesSync=function(g,a,f){var e=fs.openSync(g,constants.O_SYMLINK),c,d,h;try{var h=fs.futimesSync(e,a,f)}catch(b){c=b}try{fs.closeSync(e)}catch(b){d=b}if(c||d){throw (c||d)}return h}}else{if(fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")){fs.lutimes=function(d,a,c,b){fs.utimensat(d,a,c,constants.AT_SYMLINK_NOFOLLOW,b)};fs.lutimesSync=function(c,a,b){return fs.utimensatSync(c,a,b,constants.AT_SYMLINK_NOFOLLOW)}}else{fs.lutimes=function(a,b,c,d){process.nextTick(d)};fs.lutimesSync=function(){}}}}fs.chown=chownFix(fs.chown);fs.fchown=chownFix(fs.fchown);fs.lchown=chownFix(fs.lchown);fs.chownSync=chownFixSync(fs.chownSync);fs.fchownSync=chownFixSync(fs.fchownSync);fs.lchownSync=chownFixSync(fs.lchownSync);function chownFix(a){if(!a){return a}return function(d,e,c,b){return a.call(fs,d,e,c,function(f,g){if(chownErOk(f)){f=null}b(f,g)})}}function chownFixSync(a){if(!a){return a}return function(d,e,c){try{return a.call(fs,d,e,c)}catch(b){if(!chownErOk(b)){throw b}}}}function chownErOk(a){if(!a||(!process.getuid||process.getuid()!==0)&&(a.code==="EINVAL"||a.code==="EPERM")){return true}}if(!fs.lchmod){fs.lchmod=function(c,b,a){process.nextTick(a)};fs.lchmodSync=function(){}}if(!fs.lchown){fs.lchown=function(c,d,b,a){process.nextTick(a)};fs.lchownSync=function(){}}if(process.platform==="win32"){var rename_=fs.rename;fs.rename=function rename(c,e,a){var d=Date.now();rename_(c,e,function b(f){if(f&&(f.code==="EACCES"||f.code==="EPERM")&&Date.now()-d<1000){return rename_(c,e,b)}a(f)})}}var read=fs.read;fs.read=function(e,a,g,f,h,c){var b;if(c&&typeof c==="function"){var d=0;b=function(k,i,j){if(k&&k.code==="EAGAIN"&&d<10){d++;return read.call(fs,e,a,g,f,h,b)}c.apply(this,arguments)}}return read.call(fs,e,a,g,f,h,b)};var readSync=fs.readSync;fs.readSync=function(d,a,f,e,g){var b=0;while(true){try{return readSync.call(fs,d,a,f,e,g)}catch(c){if(c.code==="EAGAIN"&&b<10){b++;continue}throw c}}};