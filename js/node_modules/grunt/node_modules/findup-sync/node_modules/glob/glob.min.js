module.exports=glob;var fs=require("fs"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,inherits=require("inherits"),EE=require("events").EventEmitter,path=require("path"),isDir={},assert=require("assert").ok;function glob(d,c,a){if(typeof c==="function"){a=c,c={}}if(!c){c={}}if(typeof c==="number"){deprecated();return}var b=new Glob(d,c,a);return b.sync?b.found:b}glob.fnmatch=deprecated;function deprecated(){throw new Error("glob's interface has changed. Please see the docs.")}glob.sync=globSync;function globSync(b,a){if(typeof a==="number"){deprecated();return}a=a||{};a.sync=true;return glob(b,a)}this._processingEmitQueue=false;glob.Glob=Glob;inherits(Glob,EE);function Glob(g,f,a){if(!(this instanceof Glob)){return new Glob(g,f,a)}if(typeof f==="function"){a=f;f=null}if(typeof a==="function"){this.on("error",a);this.on("end",function(h){a(null,h)})}f=f||{};this._endEmitted=false;this.EOF={};this._emitQueue=[];this.paused=false;this._processingEmitQueue=false;this.maxDepth=f.maxDepth||1000;this.maxLength=f.maxLength||Infinity;this.cache=f.cache||{};this.statCache=f.statCache||{};this.changedCwd=false;var b=process.cwd();if(!f.hasOwnProperty("cwd")){this.cwd=b}else{this.cwd=f.cwd;this.changedCwd=path.resolve(f.cwd)!==b}this.root=f.root||path.resolve(this.cwd,"/");this.root=path.resolve(this.root);if(process.platform==="win32"){this.root=this.root.replace(/\\/g,"/")}this.nomount=!!f.nomount;if(!g){throw new Error("must provide pattern")}if(f.matchBase&&-1===g.indexOf("/")){if(f.noglobstar){throw new Error("base matching requires globstar")}g="**/"+g}this.strict=f.strict!==false;this.dot=!!f.dot;this.mark=!!f.mark;this.sync=!!f.sync;this.nounique=!!f.nounique;this.nonull=!!f.nonull;this.nosort=!!f.nosort;this.nocase=!!f.nocase;this.stat=!!f.stat;this.debug=!!f.debug||!!f.globDebug;if(this.debug){this.log=console.error}this.silent=!!f.silent;var d=this.minimatch=new Minimatch(g,f);this.options=d.options;g=this.pattern=d.pattern;this.error=null;this.aborted=false;this._globstars={};EE.call(this);var e=this.minimatch.set.length;this.matches=new Array(e);this.minimatch.set.forEach(c.bind(this));function c(j,h,k){this._process(j,0,h,function(i){if(i){this.emit("error",i)}if(--e<=0){this._finish()}})}}Glob.prototype.log=function(){};Glob.prototype._finish=function(){assert(this instanceof Glob);var g=this.nounique,a=g?[]:{};for(var b=0,c=this.matches.length;b<c;b++){var f=this.matches[b];this.log("matches[%d] =",b,f);if(!f){if(this.nonull){var d=this.minimatch.globSet[b];if(g){a.push(d)}else{a[d]=true}}}else{var e=Object.keys(f);if(g){a.push.apply(a,e)}else{e.forEach(function(h){a[h]=true})}}}if(!g){a=Object.keys(a)}if(!this.nosort){a=a.sort(this.nocase?alphasorti:alphasort)}if(this.mark){a=a.map(this._mark,this)}this.log("emitting end",a);this.EOF=this.found=a;this.emitMatch(this.EOF)};function alphasorti(c,d){c=c.toLowerCase();d=d.toLowerCase();return alphasort(c,d)}function alphasort(c,d){return c>d?1:c<d?-1:0}Glob.prototype._mark=function(e){var a=this.cache[e];var d=e;if(a){var b=a===2||Array.isArray(a);var f=e.slice(-1)==="/";if(b&&!f){d+="/"}else{if(!b&&f){d=d.slice(0,-1)}}if(d!==e){this.statCache[d]=this.statCache[e];this.cache[d]=this.cache[e]}}return d};Glob.prototype.abort=function(){this.aborted=true;this.emit("abort")};Glob.prototype.pause=function(){if(this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=true;this.emit("pause")};Glob.prototype.resume=function(){if(!this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=false;this.emit("resume");this._processEmitQueue()};Glob.prototype.emitMatch=function(a){this.log("emitMatch",a);this._emitQueue.push(a);this._processEmitQueue()};Glob.prototype._processEmitQueue=function(c){this.log("pEQ paused=%j processing=%j m=%j",this.paused,this._processingEmitQueue,c);var a=false;while(!this._processingEmitQueue&&!this.paused){this._processingEmitQueue=true;var c=this._emitQueue.shift();this.log(">processEmitQueue",c===this.EOF?":EOF:":c);if(!c){this.log(">processEmitQueue, falsey m");this._processingEmitQueue=false;break}if(c===this.EOF||!(this.mark&&!this.stat)){this.log("peq: unmarked, or eof");d.call(this,0,false)}else{if(this.statCache[c]){var e=this.statCache[c];var b;if(e){b=e.isDirectory()?2:1}this.log("peq: stat cached");d.call(this,b,b===2)}else{this.log("peq: _stat, then next");this._stat(c,d)}}function d(g,h){this.log("next",c,g,h);var f=c===this.EOF?"end":"match";assert(!this._endEmitted);if(f==="end"){this._endEmitted=true}if(g){if(h&&!c.match(/\/$/)){c=c+"/"}else{if(!h&&c.match(/\/$/)){c=c.replace(/\/+$/,"")}}}this.log("emit",f,c);this.emit(f,c);this._processingEmitQueue=false;if(a&&c!==this.EOF&&!this.paused){this._processEmitQueue()}}}a=true};Glob.prototype._process=function(f,c,d,b){assert(this instanceof Glob);var a=function a(i,j){assert(this instanceof Glob);if(this.paused){if(!this._processQueue){this._processQueue=[];this.once("resume",function(){var k=this._processQueue;this._processQueue=null;k.forEach(function(l){l()})})}this._processQueue.push(b.bind(this,i,j))}else{b.call(this,i,j)}}.bind(this);if(this.aborted){return a()}if(c>this.maxDepth){return a()}var e=0;while(typeof f[e]==="string"){e++}var g;switch(e){case f.length:g=f.join("/");this._stat(g,function(i,j){if(i){if(g&&isAbsolute(g)&&!this.nomount){if(g.charAt(0)==="/"){g=path.join(this.root,g)}else{g=path.resolve(this.root,g)}}if(process.platform==="win32"){g=g.replace(/\\/g,"/")}this.matches[d]=this.matches[d]||{};this.matches[d][g]=true;this.emitMatch(g)}return a()});return;case 0:g=null;break;default:g=f.slice(0,e);g=g.join("/");break}var h;if(g===null){h="."}else{if(isAbsolute(g)||isAbsolute(f.join("/"))){if(!g||!isAbsolute(g)){g=path.join("/",g)}h=g=path.resolve(g);this.log("absolute: ",g,this.root,f,h)}else{h=g}}this.log("readdir(%j)",h,this.cwd,this.root);return this._readdir(h,function(k,j){if(k){return a()}if(f[e]===minimatch.GLOBSTAR){var q=[f.slice(0,e).concat(f.slice(e+1))];j.forEach(function(l){if(l.charAt(0)==="."&&!this.dot){return}q.push(f.slice(0,e).concat(l).concat(f.slice(e+1)));q.push(f.slice(0,e).concat(l).concat(f.slice(e)))},this);q=q.filter(function(r){var l=gsKey(r);var s=!this._globstars[l];this._globstars[l]=true;return s},this);if(!q.length){return a()}var n=q.length,m=null;q.forEach(function(l){this._process(l,c+1,d,function(r){if(m){return}if(r){return a(m=r)}if(--n<=0){return a()}})},this);return}var o=f[e];var p=f[e]._glob,i=this.dot||p.charAt(0)===".";j=j.filter(function(l){return(l.charAt(0)!=="."||i)&&l.match(f[e])});if(e===f.length-1&&!this.mark&&!this.stat){j.forEach(function(l){if(g){if(g!=="/"){l=g+"/"+l}else{l=g+l}}if(l.charAt(0)==="/"&&!this.nomount){l=path.join(this.root,l)}if(process.platform==="win32"){l=l.replace(/\\/g,"/")}this.matches[d]=this.matches[d]||{};this.matches[d][l]=true;this.emitMatch(l)},this);return a.call(this)}var n=j.length,m=null;if(n===0){return a()}j.forEach(function(l){var r=f.slice(0,e).concat(l).concat(f.slice(e+1));this._process(r,c+1,d,function(s){if(m){return}if(s){return a(m=s)}if(--n===0){return a.call(this)}})},this)})};function gsKey(a){return"**"+a.map(function(b){return(b===minimatch.GLOBSTAR)?"**":(""+b)}).join("/")}Glob.prototype._stat=function(h,b){assert(this instanceof Glob);var a=h;if(h.charAt(0)==="/"){a=path.join(this.root,h)}else{if(this.changedCwd){a=path.resolve(this.cwd,h)}}if(h.length>this.maxLength){var d=new Error("Path name too long");d.code="ENAMETOOLONG";d.path=h;return this._afterStat(h,a,b,d)}this.log("stat",[this.cwd,h,"=",a]);if(!this.stat&&this.cache.hasOwnProperty(h)){var g=this.cache[h],i=g&&(Array.isArray(g)||g===2);if(this.sync){return b.call(this,!!g,i)}return process.nextTick(b.bind(this,!!g,i))}var j=this.statCache[a];if(this.sync||j){var d;try{j=fs.statSync(a)}catch(c){d=c}this._afterStat(h,a,b,d,j)}else{fs.stat(a,this._afterStat.bind(this,h,a,b))}};Glob.prototype._afterStat=function(g,a,b,d,h){var e;assert(this instanceof Glob);if(a.slice(-1)==="/"&&h&&!h.isDirectory()){this.log("should be ENOTDIR, fake it");d=new Error("ENOTDIR, not a directory '"+a+"'");d.path=a;d.code="ENOTDIR";h=null}var c=!this.statCache[a];this.statCache[a]=h;if(d||!h){e=false}else{e=h.isDirectory()?2:1;if(c){this.emit("stat",g,h)}}this.cache[g]=this.cache[g]||e;b.call(this,!!e,e===2)};Glob.prototype._readdir=function(k,d){assert(this instanceof Glob);var a=k;if(k.charAt(0)==="/"){a=path.join(this.root,k)}else{if(isAbsolute(k)){a=k}else{if(this.changedCwd){a=path.resolve(this.cwd,k)}}}if(k.length>this.maxLength){var j=new Error("Path name too long");j.code="ENAMETOOLONG";j.path=k;return this._afterReaddir(k,a,d,j)}this.log("readdir",[this.cwd,k,a]);if(this.cache.hasOwnProperty(k)){var b=this.cache[k];if(Array.isArray(b)){if(this.sync){return d.call(this,null,b)}return process.nextTick(d.bind(this,null,b))}if(!b||b===1){var g=b?"ENOTDIR":"ENOENT",j=new Error((b?"Not a directory":"Not found")+": "+k);j.path=k;j.code=g;this.log(k,j);if(this.sync){return d.call(this,j)}return process.nextTick(d.bind(this,j))}}if(this.sync){var j,i;try{i=fs.readdirSync(a)}catch(h){j=h}return this._afterReaddir(k,a,d,j,i)}fs.readdir(a,this._afterReaddir.bind(this,k,a,d))};Glob.prototype._afterReaddir=function(e,a,b,d,c){assert(this instanceof Glob);if(c&&!d){this.cache[e]=c;if(!this.mark&&!this.stat){c.forEach(function(f){if(e==="/"){f=e+f}else{f=e+"/"+f}this.cache[f]=true},this)}return b.call(this,d,c)}if(d){switch(d.code){case"ENOTDIR":this.cache[e]=1;return b.call(this,d);case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[e]=false;return b.call(this,d);default:this.cache[e]=false;if(this.strict){this.emit("error",d)}if(!this.silent){console.error("glob error",d)}return b.call(this,d)}}};var isAbsolute=process.platform==="win32"?absWin:absUnix;function absWin(d){if(absUnix(d)){return true}var f=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/,e=f.exec(d),a=e[1]||"",c=a&&a.charAt(1)!==":",b=!!e[2]||c;return b}function absUnix(a){return a.charAt(0)==="/"||a===""};