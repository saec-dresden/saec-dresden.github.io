"use strict";var util=require("util");var format=require("util").format;var Path=require("path");var _=require("underscore");_.str=require("underscore.string");var $$=require("./const");var ActionContainer=require("./action_container");var argumentErrorHelper=require("./argument/error");var HelpFormatter=require("./help/formatter");var Namespace=require("./namespace");var ArgumentParser=module.exports=function ArgumentParser(c){var d=this;c=c||{};c.description=(c.description||null);c.argumentDefault=(c.argumentDefault||null);c.prefixChars=(c.prefixChars||"-");c.conflictHandler=(c.conflictHandler||"error");ActionContainer.call(this,c);c.addHelp=(c.addHelp===undefined||!!c.addHelp);c.parents=(c.parents||[]);c.prog=(c.prog||Path.basename(process.argv[1]));this.prog=c.prog;this.usage=c.usage;this.epilog=c.epilog;this.version=c.version;this.debug=(c.debug===true);this.formatterClass=(c.formatterClass||HelpFormatter);this.fromfilePrefixChars=c.fromfilePrefixChars||null;this._positionals=this.addArgumentGroup({title:"Positional arguments"});this._optionals=this.addArgumentGroup({title:"Optional arguments"});this._subparsers=null;var b=function(e){return e};this.register("type","auto",b);this.register("type",null,b);this.register("type","int",function(f){var e=parseInt(f,10);if(isNaN(e)){throw new Error(f+" is not a valid integer.")}return e});this.register("type","float",function(f){var e=parseFloat(f);if(isNaN(e)){throw new Error(f+" is not a valid float.")}return e});this.register("type","string",function(e){return""+e});var a=(this.prefixChars.indexOf("-")>-1)?"-":this.prefixChars[0];if(c.addHelp){this.addArgument([a+"h",a+a+"help"],{action:"help",defaultValue:$$.SUPPRESS,help:"Show this help message and exit."})}if(this.version!==undefined){this.addArgument([a+"v",a+a+"version"],{action:"version",version:this.version,defaultValue:$$.SUPPRESS,help:"Show program's version number and exit."})}c.parents.forEach(function(f){d._addContainerActions(f);if(f._defaults!==undefined){for(var e in f._defaults){if(f._defaults.hasOwnProperty(e)){d._defaults[e]=f._defaults[e]}}}})};util.inherits(ArgumentParser,ActionContainer);ArgumentParser.prototype.addSubparsers=function(d){if(!!this._subparsers){this.error("Cannot have multiple subparser arguments.")}d=d||{};d.debug=(this.debug===true);d.optionStrings=[];d.parserClass=(d.parserClass||ArgumentParser);if(!!d.title||!!d.description){this._subparsers=this.addArgumentGroup({title:(d.title||"subcommands"),description:d.description});delete d.title;delete d.description}else{this._subparsers=this._positionals}if(!d.prog){var b=this._getFormatter();var f=this._getPositionalActions();var c=this._mutuallyExclusiveGroups;b.addUsage(this.usage,f,c,"");d.prog=_.str.strip(b.formatHelp())}var e=this._popActionClass(d,"parsers");var a=new e(d);this._subparsers._addAction(a);return a};ArgumentParser.prototype._addAction=function(a){if(a.isOptional()){this._optionals._addAction(a)}else{this._positionals._addAction(a)}return a};ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(a){return a.isOptional()})};ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(a){return a.isPositional()})};ArgumentParser.prototype.parseArgs=function(a,c){var b;var d=this.parseKnownArgs(a,c);a=d[0];b=d[1];if(b&&b.length>0){this.error(format("Unrecognized arguments: %s.",b.join(" ")))}return a};ArgumentParser.prototype.parseKnownArgs=function(a,c){var f=this;a=a||process.argv.slice(2);c=c||new Namespace();f._actions.forEach(function(e){if(e.dest!==$$.SUPPRESS){if(!_.has(c,e.dest)){if(e.defaultValue!==$$.SUPPRESS){var g=e.defaultValue;if(_.isString(e.defaultValue)){g=f._getValue(e,g)}c[e.dest]=g}}}});_.keys(f._defaults).forEach(function(e){c[e]=f._defaults[e]});try{var d=this._parseKnownArgs(a,c);c=d[0];a=d[1];if(_.has(c,$$._UNRECOGNIZED_ARGS_ATTR)){a=_.union(a,c[$$._UNRECOGNIZED_ARGS_ATTR]);delete c[$$._UNRECOGNIZED_ARGS_ATTR]}return[c,a]}catch(b){this.error(b)}};ArgumentParser.prototype._parseKnownArgs=function(e,m){var u=this;var j=[];if(this.fromfilePrefixChars!==null){e=this._readArgsFromFiles(e)}function b(z){return z.getName()}var g,k;var a={};this._mutuallyExclusiveGroups.forEach(function(z){z._groupActions.forEach(function(C,B,A){k=b(C);if(!_.has(a,k)){a[k]=[]}g=a[k];g.push.apply(g,A.slice(0,B));g.push.apply(g,A.slice(B+1))})});var o={};var d=[];e.forEach(function(z,A){if(z==="--"){d.push("-");while(A<e.length){d.push("A");A++}}else{var C;var B=u._parseOptional(z);if(!B){C="A"}else{o[A]=B;C="O"}d.push(C)}});var f=d.join("");var s=[];var t=[];function y(z,A,C){s.push(z);var B=u._getValues(z,A);if(B!==z.defaultValue){t.push(z);if(!!a[b(z)]){a[b(z)].forEach(function(D){if(t.indexOf(D)>=0){throw argumentErrorHelper(z,format('Not allowed with argument "%s".',D.getName()))}})}}if(B!==$$.SUPPRESS){z.call(u,m,B,C)}}function h(O){var L=o[O];var z=L[0];var K=L[1];var E=L[2];var A=[];var C,B,N,P;while(true){if(!z){j.push(e[O]);return O+1}if(!!E){B=u._matchArgument(z,"A");var D=u.prefixChars;if(B===0&&D.indexOf(K[1])<0){A.push([z,[],K]);K=K[0]+E[0];var I=E.slice(1)||null;var J=u._optionStringActions;if(_.keys(J).indexOf(K)>=0){z=J[K];E=I}else{var H="ignored explicit argument %r";throw argumentErrorHelper(z,H)}}else{if(B===1){P=O+1;C=[E];A.push([z,C,K]);break}else{var G="ignored explicit argument %r";throw argumentErrorHelper(z,_.str.sprintf(G,E))}}}else{N=O+1;var M=f.substr(N);B=u._matchArgument(z,M);P=N+B;C=e.slice(N,P);A.push([z,C,K]);break}}if(A.length<1){throw new Error("length should be > 0")}for(var F=0;F<A.length;F++){y.apply(u,A[F])}return P}var q=u._getPositionalActions();function i(B){var A=f.substr(B);var z=u._matchArgumentsPartial(q,A);_.zip(q,z).forEach(function(F){var C=F[0];var D=F[1];if(D===undefined){return}var E=e.slice(B,B+D);B+=D;y(C,E)});q=q.slice(z.length);return B}var v=0;var p;var l=-1;Object.keys(o).forEach(function(z){l=Math.max(l,parseInt(z,10))});var r,n;while(v<=l){n=null;for(p in o){if(!o.hasOwnProperty(p)){continue}p=parseInt(p,10);if(p>=v){if(n!==null){n=Math.min(n,p)}else{n=p}}}if(v!==n){r=i(v);if(r>v){v=r;continue}else{v=r}}if(!o[v]){var x=e.slice(v,n);j=j.concat(x);v=n}v=h(v)}var w=i(v);j=j.concat(_.rest(e,w));if(q.length>0){u.error("too few arguments")}u._actions.forEach(function(z){if(z.required){if(_.indexOf(s,z)<0){u.error(format('Argument "%s" is required',z.getName()))}}});var c=false;u._mutuallyExclusiveGroups.forEach(function(z){if(z.required){c=_.any(z._groupActions,function(C){return _.contains(t,C)});if(!c){var B=[];z._groupActions.forEach(function(C){if(C.help!==$$.SUPPRESS){B.push(C.getName())}});B=B.join(" ");var A="one of the arguments "+B+" is required";u.error(A)}}});return[m,j]};ArgumentParser.prototype._readArgsFromFiles=function(b){var a=this;var c=require("fs");var d=[];b.forEach(function(e){if(a.fromfilePrefixChars.indexOf(e[0])<0){d.push(e)}else{try{var f=[];var i=e.slice(1);var g=c.readFileSync(i,"utf8");g=g.trim().split("\n");g.forEach(function(j){a.convertArgLineToArgs(j).forEach(function(k){f.push(k)});f=a._readArgsFromFiles(f)});d.push.apply(d,f)}catch(h){return a.error(h.message)}}});return d};ArgumentParser.prototype.convertArgLineToArgs=function(a){return[a]};ArgumentParser.prototype._matchArgument=function(a,d){var e=new RegExp("^"+this._getNargsPattern(a));var b=d.match(e);var c;if(!b){switch(a.nargs){case undefined:case null:c="Expected one argument.";break;case $$.OPTIONAL:c="Expected at most one argument.";break;case $$.ONE_OR_MORE:c="Expected at least one argument.";break;default:c="Expected %s argument(s)"}throw argumentErrorHelper(a,format(c,a.nargs))}return b[1].length};ArgumentParser.prototype._matchArgumentsPartial=function(a,h){var l=this;var k=[];var b,g,f;var d,e;var c=function(i){return i.length};for(d=a.length;d>0;d--){g="";b=a.slice(0,d);for(e=0;e<b.length;e++){g+=l._getNargsPattern(b[e])}g=new RegExp("^"+g);f=h.match(g);if(f&&f.length>0){f=f.splice(1);k=k.concat(f.map(c));break}}return k};ArgumentParser.prototype._parseOptional=function(c){var a,e,b,g;if(!c){return null}if(this.prefixChars.indexOf(c[0])<0){return null}if(!!this._optionStringActions[c]){return[this._optionStringActions[c],c,null]}if(c.length===1){return null}if(c.indexOf("=")>=0){var d=c.split("=");e=d[0];b=d[1];if(!!this._optionStringActions[e]){a=this._optionStringActions[e];return[a,e,b]}}g=this._getOptionTuples(c);if(g.length>1){var f=g.map(function(h){return h[1]});this.error(format('Ambiguous option: "%s" could match %s.',c,f.join(", ")))}else{if(g.length===1){return g[0]}}if(c.match(this._regexpNegativeNumber)){if(!_.any(this._hasNegativeNumberOptionals)){return null}}if(c.search(" ")>=0){return null}return[null,c,null]};ArgumentParser.prototype._getOptionTuples=function(h){var j=[];var e=this.prefixChars;var f;var c;var a;var b;if(e.indexOf(h[0])>=0&&e.indexOf(h[1])>=0){if(h.indexOf("=")>=0){var i=h.split("=",1);f=i[0];c=i[1]}else{f=h;c=null}for(b in this._optionStringActions){if(b.substr(0,f.length)===f){a=this._optionStringActions[b];j.push([a,b,c])}}}else{if(e.indexOf(h[0])>=0&&e.indexOf(h[1])<0){f=h;c=null;var g=h.substr(0,2);var d=h.substr(2);for(b in this._optionStringActions){a=this._optionStringActions[b];if(b===g){j.push([a,b,d])}else{if(b.substr(0,f.length)===f){j.push([a,b,c])}}}}else{throw new Error(format("Unexpected option string: %s.",h))}}return j};ArgumentParser.prototype._getNargsPattern=function(a){var b;switch(a.nargs){case undefined:case null:b="(-*A-*)";break;case $$.OPTIONAL:b="(-*A?-*)";break;case $$.ZERO_OR_MORE:b="(-*[A-]*)";break;case $$.ONE_OR_MORE:b="(-*A[A-]*)";break;case $$.REMAINDER:b="([-AO]*)";break;case $$.PARSER:b="(-*A[-AO]*)";break;default:b="(-*"+_.str.repeat("-*A",a.nargs)+"-*)"}if(a.isOptional()){b=b.replace(/-\*/g,"");b=b.replace(/-/g,"")}return b};ArgumentParser.prototype._getValues=function(a,c){var d=this;if(a.nargs!==$$.PARSER&&a.nargs!==$$.REMAINDER){c=c.filter(function(f){return f!=="--"})}var e,b;if(c.length===0&&a.nargs===$$.OPTIONAL){e=(a.isOptional())?a.constant:a.defaultValue;if(typeof(e)==="string"){e=this._getValue(a,e);this._checkValue(a,e)}}else{if(c.length===0&&a.nargs===$$.ZERO_OR_MORE&&a.optionStrings.length===0){e=(a.defaultValue||c);this._checkValue(a,e)}else{if(c.length===1&&(!a.nargs||a.nargs===$$.OPTIONAL)){b=c[0];e=this._getValue(a,b);this._checkValue(a,e)}else{if(a.nargs===$$.REMAINDER){e=c.map(function(f){return d._getValue(a,f)})}else{if(a.nargs===$$.PARSER){e=c.map(function(f){return d._getValue(a,f)});this._checkValue(a,e[0])}else{e=c.map(function(f){return d._getValue(a,f)});e.forEach(function(f){d._checkValue(a,f)})}}}}}return e};ArgumentParser.prototype._getValue=function(a,b){var h;var i=this._registryGet("type",a.type,a.type);if(!_.isFunction(i)){var d=format("%s is not callable",i);throw argumentErrorHelper(a,d)}try{h=i(b)}catch(c){var g=null;if(_.isString(a.type)){g=a.type}else{g=a.type.name||a.type.displayName||"<function>"}var f=format("Invalid %s value: %s",g,b);if(g==="<function>"){f+="\n"+c.message}throw argumentErrorHelper(a,f)}return h};ArgumentParser.prototype._checkValue=function(a,d){var b=a.choices;if(!!b){if((_.isString(b)||_.isArray(b))&&b.indexOf(d)!==-1){return}if(_.isObject(b)&&!_.isArray(b)&&b[d]){return}if(_.isString(b)){b=b.split("").join(", ")}else{if(_.isArray(b)){b=b.join(", ")}else{b=_.keys(b).join(", ")}}var c=format("Invalid choice: %s (choose from [%s])",d,b);throw argumentErrorHelper(a,c)}};ArgumentParser.prototype.formatUsage=function(){var a=this._getFormatter();a.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);return a.formatHelp()};ArgumentParser.prototype.formatHelp=function(){var a=this._getFormatter();a.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);a.addText(this.description);this._actionGroups.forEach(function(b){a.startSection(b.title);a.addText(b.description);a.addArguments(b._groupActions);a.endSection()});a.addText(this.epilog);return a.formatHelp()};ArgumentParser.prototype._getFormatter=function(){var b=this.formatterClass;var a=new b({prog:this.prog});return a};ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())};ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())};ArgumentParser.prototype._printMessage=function(a,b){if(!b){b=process.stdout}if(a){b.write(""+a)}};ArgumentParser.prototype.exit=function(b,a){if(!!a){if(b===0){this._printMessage(a)}else{this._printMessage(a,process.stderr)}}process.exit(b)};ArgumentParser.prototype.error=function(a){var b;if(a instanceof Error){if(this.debug===true){throw a}b=a.message}else{b=a}var c=format("%s: error: %s",this.prog,b)+$$.EOL;if(this.debug===true){throw new Error(c)}this.printUsage(process.stderr);return this.exit(2,c)};