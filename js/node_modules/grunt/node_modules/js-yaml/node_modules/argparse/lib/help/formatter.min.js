"use strict";var _=require("underscore");_.str=require("underscore.string");var $$=require("../const");function Section(b,a){this._parent=b;this._heading=a;this._items=[]}Section.prototype.addItem=function(a){this._items.push(a)};Section.prototype.formatHelp=function(b){var d,c;if(!!this._parent){b._indent()}d=this._items.map(function(g){var h,f,e;h=b;f=g[0];e=g[1];return f.apply(h,e)});d=b._joinParts(d);if(!!this._parent){b._dedent()}if(!d){return""}c="";if(!!this._heading&&this._heading!==$$.SUPPRESS){var a=b.currentIndent;c=_.str.repeat(" ",a)+this._heading+":"+$$.EOL}return b._joinParts([$$.EOL,c,d,$$.EOL])};var HelpFormatter=module.exports=function HelpFormatter(a){a=a||{};this._prog=a.prog;this._maxHelpPosition=a.maxHelpPosition||24;this._width=(a.width||((process.env.COLUMNS||80)-2));this._currentIndent=0;this._indentIncriment=a.indentIncriment||2;this._level=0;this._actionMaxLength=0;this._rootSection=new Section(null);this._currentSection=this._rootSection;this._whitespaceMatcher=new RegExp("\\s+","g");this._longBreakMatcher=new RegExp($$.EOL+$$.EOL+$$.EOL+"+","g")};HelpFormatter.prototype._indent=function(){this._currentIndent+=this._indentIncriment;this._level+=1};HelpFormatter.prototype._dedent=function(){this._currentIndent-=this._indentIncriment;this._level-=1;if(this._currentIndent<0){throw new Error("Indent decreased below 0.")}};HelpFormatter.prototype._addItem=function(b,a){this._currentSection.addItem([b,a])};HelpFormatter.prototype.startSection=function(b){this._indent();var c=new Section(this._currentSection,b);var a=c.formatHelp.bind(c);this._addItem(a,[this]);this._currentSection=c};HelpFormatter.prototype.endSection=function(){this._currentSection=this._currentSection._parent;this._dedent()};HelpFormatter.prototype.addText=function(a){if(!!a&&a!==$$.SUPPRESS){this._addItem(this._formatText,[a])}};HelpFormatter.prototype.addUsage=function(d,a,b,c){if(d!==$$.SUPPRESS){this._addItem(this._formatUsage,[d,a,b,c])}};HelpFormatter.prototype.addArgument=function(a){if(a.help!==$$.SUPPRESS){var e=this;var d=[this._formatActionInvocation(a)];var c=d[0].length;var b;if(!!a._getSubactions){this._indent();a._getSubactions().forEach(function(g){var f=e._formatActionInvocation(g);d.push(f);c=Math.max(c,f.length)});this._dedent()}b=c+this._currentIndent;this._actionMaxLength=Math.max(this._actionMaxLength,b);this._addItem(this._formatAction,[a])}};HelpFormatter.prototype.addArguments=function(a){var b=this;a.forEach(function(c){b.addArgument(c)})};HelpFormatter.prototype.formatHelp=function(){var a=this._rootSection.formatHelp(this);if(a){a=a.replace(this._longBreakMatcher,$$.EOL+$$.EOL);a=_.str.strip(a,$$.EOL)+$$.EOL}return a};HelpFormatter.prototype._joinParts=function(a){return a.filter(function(b){return(!!b&&b!==$$.SUPPRESS)}).join("")};HelpFormatter.prototype._formatUsage=function(r,b,d,n){if(!n&&!_.isString(n)){n="usage: "}b=b||[];d=d||[];if(r){r=_.str.sprintf(r,{prog:this._prog})}else{if(!r&&b.length===0){r=this._prog}else{if(!r){var o=this._prog;var h=[];var l=[];var c;var q;b.forEach(function(s){if(s.isOptional()){h.push(s)}else{l.push(s)}});c=this._formatActionsUsage([].concat(h,l),d);r=[o,c].join(" ");q=this._width-this._currentIndent;if((n.length+r.length)>q){var p=new RegExp("\\(.*?\\)+|\\[.*?\\]+|\\S+","g");var i=this._formatActionsUsage(h,d);var m=this._formatActionsUsage(l,d);var g=i.match(p);var k=m.match(p)||[];if(g.join(" ")!==i){throw new Error("assert \"optionalParts.join(' ') === optionalUsage\"")}if(k.join(" ")!==m){throw new Error("assert \"positionalParts.join(' ') === positionalUsage\"")}var a=function(w,s,x){var v=[];var t=[];var u=!!x?x.length-1:s.length-1;w.forEach(function(y){if(u+1+y.length>q){v.push(s+t.join(" "));t=[];u=s.length-1}t.push(y);u+=y.length+1});if(t){v.push(s+t.join(" "))}if(x){v[0]=v[0].substr(s.length)}return v};var f,e,j;if(n.length+o.length<=0.75*q){e=_.str.repeat(" ",(n.length+o.length+1));if(g){f=[].concat(a([o].concat(g),e,n),a(k,e))}else{if(k){f=a([o].concat(k),e,n)}else{f=[o]}}}else{e=_.str.repeat(" ",n.length);j=g+k;f=a(j,e);if(f.length>1){f=[].concat(a(g,e),a(k,e))}f=[o]+f}r=f.join($$.EOL)}}}}return n+r+$$.EOL+$$.EOL};HelpFormatter.prototype._formatActionsUsage=function(a,c){var b=[];var e=[];var g=this;c.forEach(function(k){var j;var l;var m=a.indexOf(k._groupActions[0]);if(m>=0){j=m+k._groupActions.length;if(_.isEqual(a.slice(m,j),k._groupActions)){k._groupActions.forEach(function(i){b.push(i)});if(!k.required){if(!!e[m]){e[m]+=" ["}else{e[m]="["}e[j]="]"}else{if(!!e[m]){e[m]+=" ("}else{e[m]="("}e[j]=")"}for(l=m+1;l<j;l+=1){e[l]="|"}}}});var f=[];a.forEach(function(i,j){var n;var m;var k;var l;if(i.help===$$.SUPPRESS){f.push(null);if(e[j]==="|"){e.splice(j,j)}else{if(e[j+1]==="|"){e.splice(j+1,j+1)}}}else{if(!i.isOptional()){n=g._formatArgs(i,i.dest);if(b.indexOf(i)>=0){if(n[0]==="["&&n[n.length-1]==="]"){n=n.slice(1,-1)}}f.push(n)}else{m=i.optionStrings[0];if(i.nargs===0){n=""+m}else{k=i.dest.toUpperCase();l=g._formatArgs(i,k);n=m+" "+l}if(!i.required&&b.indexOf(i)<0){n="["+n+"]"}f.push(n)}}});for(var d=e.length-1;d>=0;--d){if(e[d]!==null){f.splice(d,0,e[d])}}var h=f.filter(function(i){return !!i}).join(" ");h=h.replace(/([\[(]) /g,"$1");h=h.replace(/ ([\])])/g,"$1");h=h.replace(/\[ *\]/g,"");h=h.replace(/\( *\)/g,"");h=h.replace(/\(([^|]*)\)/g,"$1");h=_.str.strip(h);return h};HelpFormatter.prototype._formatText=function(b){b=_.str.sprintf(b,{prog:this._prog});var c=this._width-this._currentIndent;var a=_.str.repeat(" ",this._currentIndent);return this._fillText(b,c,a)+$$.EOL+$$.EOL};HelpFormatter.prototype._formatAction=function(a){var j=this;var f;var d;var i;var h;var e=Math.min(this._actionMaxLength+2,this._maxHelpPosition);var g=this._width-e;var c=e-this._currentIndent-2;var b=this._formatActionInvocation(a);if(!a.help){b=_.str.repeat(" ",this._currentIndent)+b+$$.EOL}else{if(b.length<=c){b=_.str.repeat(" ",this._currentIndent)+b+"  "+_.str.repeat(" ",c-b.length);h=0}else{b=_.str.repeat(" ",this._currentIndent)+b+$$.EOL;h=e}}i=[b];if(!!a.help){f=this._expandHelp(a);d=this._splitLines(f,g);i.push(_.str.repeat(" ",h)+d[0]+$$.EOL);d.slice(1).forEach(function(k){i.push(_.str.repeat(" ",e)+k+$$.EOL)})}else{if(b.charAt(b.length-1)!==$$.EOL){i.push($$.EOL)}}if(!!a._getSubactions){this._indent();a._getSubactions().forEach(function(k){i.push(j._formatAction(k))});this._dedent()}return this._joinParts(i)};HelpFormatter.prototype._formatActionInvocation=function(a){if(!a.isOptional()){var d=this._metavarFormatter(a,a.dest);var e=d(1);return e[0]}else{var f=[];var b;var c;if(a.nargs===0){f=f.concat(a.optionStrings)}else{b=a.dest.toUpperCase();c=this._formatArgs(a,b);a.optionStrings.forEach(function(g){f.push(g+" "+c)})}return f.join(", ")}};HelpFormatter.prototype._metavarFormatter=function(a,c){var d;if(!!a.metavar||a.metavar===""){d=a.metavar}else{if(!!a.choices){var b=a.choices;if(_.isString(b)){b=b.split("").join(", ")}else{if(_.isArray(b)){b=b.join(",")}else{b=_.keys(b).join(",")}}d="{"+b+"}"}else{d=c}}return function(g){if(Array.isArray(d)){return d}else{var f=[];for(var e=0;e<g;e+=1){f.push(d)}return f}}};HelpFormatter.prototype._formatArgs=function(a,c){var e;var d;var b=this._metavarFormatter(a,c);switch(a.nargs){case undefined:case null:d=b(1);e=""+d[0];break;case $$.OPTIONAL:d=b(1);e="["+d[0]+"]";break;case $$.ZERO_OR_MORE:d=b(2);e="["+d[0]+" ["+d[1]+" ...]]";break;case $$.ONE_OR_MORE:d=b(2);e=""+d[0]+" ["+d[1]+" ...]";break;case $$.REMAINDER:e="...";break;case $$.PARSER:d=b(1);e=d[0]+" ...";break;default:d=b(a.nargs);e=d.join(" ")}return e};HelpFormatter.prototype._expandHelp=function(a){var b={prog:this._prog};Object.keys(a).forEach(function(c){var d=a[c];if(d!==$$.SUPPRESS){b[c]=d}});if(!!b.choices){if(_.isString(b.choices)){b.choices=b.choices.split("").join(", ")}else{if(_.isArray(b.choices)){b.choices=b.choices.join(", ")}else{b.choices=_.keys(b.choices).join(", ")}}}return _.str.sprintf(this._getHelpString(a),b)};HelpFormatter.prototype._splitLines=function(d,e){var b=[];var a=[" ",".",",","!","?"];var c=new RegExp("["+a.join("")+"][^"+a.join("")+"]*$");d=d.replace(/[\n\|\t]/g," ");d=_.str.strip(d);d=d.replace(this._whitespaceMatcher," ");d.split($$.EOL).forEach(function(g){if(e>=g.length){b.push(g);return}var i=0;var h=e;var f=0;while(h<=g.length){if(h!==g.length&&a.indexOf(g[h]<-1)){f=(c.exec(g.substring(i,h))||{}).index;h=i+f+1}b.push(g.substring(i,h));i=h;h+=e}if(i<g.length){b.push(g.substring(i,h))}});return b};HelpFormatter.prototype._fillText=function(c,d,a){var b=this._splitLines(c,d);b=b.map(function(e){return a+e});return b.join($$.EOL)};HelpFormatter.prototype._getHelpString=function(a){return a.help};