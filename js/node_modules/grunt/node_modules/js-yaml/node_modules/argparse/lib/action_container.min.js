"use strict";var format=require("util").format;var _=require("underscore");_.str=require("underscore.string");var $$=require("./const");var ActionHelp=require("./action/help");var ActionAppend=require("./action/append");var ActionAppendConstant=require("./action/append/constant");var ActionCount=require("./action/count");var ActionStore=require("./action/store");var ActionStoreConstant=require("./action/store/constant");var ActionStoreTrue=require("./action/store/true");var ActionStoreFalse=require("./action/store/false");var ActionVersion=require("./action/version");var ActionSubparsers=require("./action/subparsers");var argumentErrorHelper=require("./argument/error");var ActionContainer=module.exports=function ActionContainer(a){a=a||{};this.description=a.description;this.argumentDefault=a.argumentDefault;this.prefixChars=a.prefixChars||"";this.conflictHandler=a.conflictHandler;this._registries={};this.register("action",null,ActionStore);this.register("action","store",ActionStore);this.register("action","storeConst",ActionStoreConstant);this.register("action","storeTrue",ActionStoreTrue);this.register("action","storeFalse",ActionStoreFalse);this.register("action","append",ActionAppend);this.register("action","appendConst",ActionAppendConstant);this.register("action","count",ActionCount);this.register("action","help",ActionHelp);this.register("action","version",ActionVersion);this.register("action","parsers",ActionSubparsers);this._getHandler();this._actions=[];this._optionStringActions={};this._actionGroups=[];this._mutuallyExclusiveGroups=[];this._defaults={};this._regexpNegativeNumber=new RegExp("^[-]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$");this._hasNegativeNumberOptionals=[]};var ArgumentGroup=require("./argument/group");var MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(b,c,a){this._registries[b]=this._registries[b]||{};this._registries[b][c]=a};ActionContainer.prototype._registryGet=function(b,c,a){if(3>arguments.length){a=null}return this._registries[b][c]||a};ActionContainer.prototype.setDefaults=function(a){a=a||{};for(var b in a){this._defaults[b]=a[b]}this._actions.forEach(function(c){if(c.dest in a){c.defaultValue=a[c.dest]}})};ActionContainer.prototype.getDefault=function(a){var b=(_.has(this._defaults,a))?this._defaults[a]:null;this._actions.forEach(function(c){if(c.dest===a&&_.has(c,"defaultValue")){b=c.defaultValue}});return b};ActionContainer.prototype.addArgument=function(c,e){c=c;e=e||{};if(!_.isArray(c)){throw new TypeError("addArgument first argument should be an array")}if(!_.isObject(e)||_.isArray(e)){throw new TypeError("addArgument second argument should be a hash")}if(!c||c.length===1&&this.prefixChars.indexOf(c[0][0])<0){if(c&&!!e.dest){throw new Error("dest supplied twice for positional argument")}e=this._getPositional(c,e)}else{e=this._getOptional(c,e)}if(_.isUndefined(e.defaultValue)){var d=e.dest;if(_.has(this._defaults,d)){e.defaultValue=this._defaults[d]}else{if(!_.isUndefined(this.argumentDefault)){e.defaultValue=this.argumentDefault}}}var b=this._popActionClass(e);if(!_.isFunction(b)){throw new Error(format('Unknown action "%s".',b))}var a=new b(e);var f=this._registryGet("type",a.type,a.type);if(!_.isFunction(f)){throw new Error(format('"%s" is not callable',f))}return this._addAction(a)};ActionContainer.prototype.addArgumentGroup=function(b){var a=new ArgumentGroup(this,b);this._actionGroups.push(a);return a};ActionContainer.prototype.addMutuallyExclusiveGroup=function(b){var a=new MutuallyExclusiveGroup(this,b);this._mutuallyExclusiveGroups.push(a);return a};ActionContainer.prototype._addAction=function(a){var b=this;this._checkConflict(a);this._actions.push(a);a.container=this;a.optionStrings.forEach(function(c){b._optionStringActions[c]=a});a.optionStrings.forEach(function(c){if(c.match(b._regexpNegativeNumber)){if(!_.any(b._hasNegativeNumberOptionals)){b._hasNegativeNumberOptionals.push(true)}}});return a};ActionContainer.prototype._removeAction=function(a){var b=this._actions.indexOf(a);if(b>=0){this._actions.splice(b,1)}};ActionContainer.prototype._addContainerActions=function(b){var e={};this._actionGroups.forEach(function(f){if(e[f.title]){throw new Error(format('Cannot merge actions - two groups are named "%s".',f.title))}e[f.title]=f});var c={};function a(f){return f.getName()}b._actionGroups.forEach(function(f){if(!e[f.title]){e[f.title]=this.addArgumentGroup({title:f.title,description:f.description})}f._groupActions.forEach(function(g){c[a(g)]=e[f.title]})},this);var d;b._mutuallyExclusiveGroups.forEach(function(f){d=this.addMutuallyExclusiveGroup({required:f.required});f._groupActions.forEach(function(g){c[a(g)]=d})},this);b._actions.forEach(function(f){var g=a(f);if(!!c[g]){c[g]._addAction(f)}else{this._addAction(f)}})};ActionContainer.prototype._getPositional=function(a,b){if(_.isArray(a)){a=_.first(a)}if(b.required){throw new Error('"required" is an invalid argument for positionals.')}if(b.nargs!==$$.OPTIONAL&&b.nargs!==$$.ZERO_OR_MORE){b.required=true}if(b.nargs===$$.ZERO_OR_MORE&&b.defaultValue===undefined){b.required=true}b.dest=a;b.optionStrings=[];return b};ActionContainer.prototype._getOptional=function(a,c){var g=this.prefixChars;var e=[];var f=[];a.forEach(function(h){if(g.indexOf(h[0])<0){throw new Error(format('Invalid option string "%s": must start with a "%s".',h,g))}e.push(h);if(h.length>1&&g.indexOf(h[1])>=0){f.push(h)}});var b=c.dest||null;delete c.dest;if(!b){var d=f.length?f[0]:e[0];b=_.str.strip(d,this.prefixChars);if(b.length===0){throw new Error(format('dest= is required for options like "%s"',e.join(", ")))}b=b.replace(/-/g,"_")}c.dest=b;c.optionStrings=e;return c};ActionContainer.prototype._popActionClass=function(d,c){c=c||null;var a=(d.action||c);delete d.action;var b=this._registryGet("action",a,a);return b};ActionContainer.prototype._getHandler=function(){var c=this.conflictHandler;var b="_handleConflict"+_.str.capitalize(c);var a=this[b];if(typeof a==="undefined"){var d="invalid conflict resolution value: "+c;throw new Error(d)}else{return a}};ActionContainer.prototype._checkConflict=function(a){var d=this._optionStringActions;var c=[];a.optionStrings.forEach(function(f){var e=d[f];if(typeof e!=="undefined"){c.push([f,e])}});if(c.length>0){var b=this._getHandler();b.call(this,a,c)}};ActionContainer.prototype._handleConflictError=function(a,c){var b=_.map(c,function(d){return d[0]});b=b.join(", ");throw argumentErrorHelper(a,format("Conflicting option string(s): %s",b))};ActionContainer.prototype._handleConflictResolve=function(a,b){var c=this;b.forEach(function(g){var f=g[0];var d=g[1];var e=d.optionStrings.indexOf(f);if(e>=0){d.optionStrings.splice(e,1)}delete c._optionStringActions[f];if(d.optionStrings.length===0){d.container._removeAction(d)}})};