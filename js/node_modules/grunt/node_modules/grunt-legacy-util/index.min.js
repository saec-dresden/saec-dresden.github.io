"use strict";var spawn=require("child_process").spawn;var nodeUtil=require("util");var path=require("path");var util=module.exports={};util.namespace=require("getobject");util.hooker=require("hooker");util.async=require("async");var _=util._=require("lodash");var which=require("which").sync;util.exit=require("exit");_.str=require("underscore.string");_.mixin(_.str.exports());util.callbackify=function(b){return function a(){var e=b.apply(this,arguments);var d=arguments.length;if(d===b.length){return}var c=arguments[d-1];if(typeof c==="function"){c(e)}}};util.error=function(a,b){if(!nodeUtil.isError(a)){a=new Error(a)}if(b){a.origError=b}return a};util.linefeed=process.platform==="win32"?"\r\n":"\n";util.normalizelf=function(a){return a.replace(/\r\n|\n/g,util.linefeed)};var kindsOf={};"Number String Boolean Function RegExp Array Date Error".split(" ").forEach(function(a){kindsOf["[object "+a+"]"]=a.toLowerCase()});util.kindOf=function(a){if(a==null){return String(a)}return kindsOf[kindsOf.toString.call(a)]||"object"};util.toArray=_.toArray;util.repeat=function(a,b){return new Array(a+1).join(b||" ")};util.pluralize=function(a,d,c){var b=d.split(c||"/");return a===1?(b[0]||""):(b[1]||"")};util.recurse=function(d,a,b){function c(k,f,g,j){var e;if(j.objs.indexOf(k)!==-1){e=new Error("Circular reference detected ("+j.path+")");e.path=j.path;throw e}var i,h;if(g&&g(k)===false){return k}else{if(util.kindOf(k)==="array"){return k.map(function(m,l){return c(m,f,g,{objs:j.objs.concat([k]),path:j.path+"["+l+"]",})})}else{if(util.kindOf(k)==="object"&&!Buffer.isBuffer(k)){i={};for(h in k){i[h]=c(k[h],f,g,{objs:j.objs.concat([k]),path:j.path+(/\W/.test(h)?'["'+h+'"]':"."+h),})}return i}else{return f(k)}}}}return c(d,a,b,{objs:[],path:""})};util.spawn=function(g,e){var b=function(k,n,m){n=_.rtrim(n);m=_.rtrim(m);var l={stdout:n,stderr:m,code:k,toString:function(){if(k===0){return n}else{if("fallback" in g){return g.fallback}else{if(g.grunt){return m||n}}}return m}};e(k===0||"fallback" in g?null:new Error(m),l,k)};var d,a;var h=/[\\\/]/g;if(g.grunt){d=process.execPath;a=process.execArgv.concat(process.argv[1],g.args)}else{try{if(!h.test(g.cmd)){d=which(g.cmd)}else{d=g.cmd.replace(h,path.sep)}}catch(f){b(127,"",String(f));return}a=g.args||[]}var c=spawn(d,a,g.opts);var j=new Buffer("");var i=new Buffer("");if(c.stdout){c.stdout.on("data",function(k){j=Buffer.concat([j,new Buffer(k)])})}if(c.stderr){c.stderr.on("data",function(k){i=Buffer.concat([i,new Buffer(k)])})}c.on("close",function(k){b(k,j.toString(),i.toString())});return c};