(function(){var b,c,i,F,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,G,H,I,J,K,L,M,N,O,a;l=require("fs");x=require("path");m=require("./helpers");t=require("./optparse");c=require("./coffee-script");a=require("child_process"),E=a.spawn,j=a.exec;i=require("events").EventEmitter;m.extend(c,new i);y=function(P){return process.stdout.write(P+"\n")};A=function(P){return process.stderr.write(P+"\n")};n=function(P){return/^\.|~$/.test(P)};b="Usage: coffee [options] path/to/script.coffee -- [args]\n\nIf called without options, `coffee` will run your script.";F=[["-b","--bare","compile without a top-level function wrapper"],["-c","--compile","compile to JavaScript and save as .js files"],["-e","--eval","pass a string from the command line as input"],["-h","--help","display this help message"],["-i","--interactive","run an interactive CoffeeScript REPL"],["-j","--join [FILE]","concatenate the source CoffeeScript before compiling"],["-l","--lint","pipe the compiled JavaScript through JavaScript Lint"],["-n","--nodes","print out the parse tree that the parser produces"],["--nodejs [ARGS]",'pass options directly to the "node" binary'],["-o","--output [DIR]","set the output directory for compiled JavaScript"],["-p","--print","print out the compiled JavaScript"],["-r","--require [FILE*]","require a library before executing your script"],["-s","--stdio","listen for and compile scripts over stdio"],["-t","--tokens","print out the tokens that the lexer/rewriter produce"],["-v","--version","display the version number"],["-w","--watch","watch scripts for changes and rerun commands"]];u={};D=[];C=[];r={};N={};s=null;exports.run=function(){var S,T,P,Q,R;w();if(u.nodejs){return k()}if(u.help){return I()}if(u.version){return J()}if(u.require){q()}if(u.interactive){return require("./repl")}if(u.watch&&!l.watch){return A("The --watch feature depends on Node v0.6.0+. You are running "+process.version+".")}if(u.stdio){return h()}if(u["eval"]){return g(null,D[0])}if(!D.length){return require("./repl")}S=u.run?D.splice(1):[];process.argv=process.argv.slice(0,2).concat(S);process.argv[0]="coffee";process.execPath=require.main.filename;R=[];for(P=0,Q=D.length;P<Q;P++){T=D[P];R.push(f(T,true,x.normalize(T)))}return R};f=function(Q,R,P){return l.stat(Q,function(S,T){if(S&&S.code!=="ENOENT"){throw S}if((S!=null?S.code:void 0)==="ENOENT"){if(R&&Q.slice(-7)!==".coffee"){Q=D[D.indexOf(Q)]=""+Q+".coffee";return f(Q,R,P)}if(R){console.error("File not found: "+Q);process.exit(1)}return}if(T.isDirectory()){if(u.watch){M(Q,P)}return l.readdir(Q,function(W,Y){var X,Z,U,V;if(W&&W.code!=="ENOENT"){throw W}if((W!=null?W.code:void 0)==="ENOENT"){return}Z=D.indexOf(Q);Y=Y.filter(function(aa){return !n(aa)});[].splice.apply(D,[Z,Z-Z+1].concat(U=(function(){var aa,ab,ac;ac=[];for(aa=0,ab=Y.length;aa<ab;aa++){X=Y[aa];ac.push(x.join(Q,X))}return ac})())),U;[].splice.apply(C,[Z,Z-Z+1].concat(V=Y.map(function(){return null}))),V;return Y.forEach(function(aa){return f(x.join(Q,aa),false,P)})})}else{if(R||x.extname(Q)===".coffee"){if(u.watch){L(Q,P)}return l.readFile(Q,function(V,U){if(V&&V.code!=="ENOENT"){throw V}if((V!=null?V.code:void 0)==="ENOENT"){return}return g(Q,U.toString(),P)})}else{r[Q]=true;return B(Q,P)}}})};g=function(R,S,P){var T,U,V,W;T=u;U=e(R);try{V=W={file:R,input:S,options:U};c.emit("compile",W);if(T.tokens){return z(c.tokens(V.input))}else{if(T.nodes){return y(c.nodes(V.input).toString().trim())}else{if(T.run){return c.run(V.input,V.options)}else{if(T.join&&V.file!==T.join){C[D.indexOf(V.file)]=V.input;return d()}else{V.output=c.compile(V.input,V.options);c.emit("success",W);if(T.print){return y(V.output.trim())}else{if(T.compile){return O(V.file,V.output,P)}else{if(T.lint){return p(V.file,V.output)}}}}}}}}catch(Q){c.emit("failure",Q,W);if(c.listeners("failure").length){return}if(T.watch){return y(Q.message+"\x07")}A(Q instanceof Error&&Q.stack||("ERROR: "+Q));return process.exit(1)}};h=function(){var P,Q;P="";Q=process.openStdin();Q.on("data",function(R){if(R){return P+=R.toString()}});return Q.on("end",function(){return g(null,P)})};o=null;d=function(){if(!u.join){return}if(!C.some(function(P){return P===null})){clearTimeout(o);return o=K(100,function(){return g(u.join,C.join("\n"),u.join)})}};q=function(){var S,T,P,Q,R;S=module.filename;module.filename=".";R=u.require;for(P=0,Q=R.length;P<Q;P++){T=R[P];require(T)}return module.filename=S};L=function(V,P){var Q,R,T,U,X,W;T=null;R=null;X=function(Y){if(Y.code==="ENOENT"){if(D.indexOf(V)===-1){return}try{U();return Q()}catch(Y){B(V,P,true);return d()}}else{throw Y}};Q=function(){clearTimeout(R);return R=K(25,function(){return l.stat(V,function(Y,Z){if(Y){return X(Y)}if(T&&Z.size===T.size&&Z.mtime.getTime()===T.mtime.getTime()){return U()}T=Z;return l.readFile(V,function(ab,aa){if(ab){return X(ab)}g(V,aa.toString(),P);return U()})})})};try{W=l.watch(V,Q)}catch(S){X(S)}return U=function(){if(W!=null){W.close()}return W=l.watch(V,Q)}};M=function(S,P){var R,T;R=null;try{return T=l.watch(S,function(){clearTimeout(R);return R=K(25,function(){return l.readdir(S,function(X,Z){var Y,U,V,W;if(X){if(X.code!=="ENOENT"){throw X}T.close();return H(S,P)}W=[];for(U=0,V=Z.length;U<V;U++){Y=Z[U];if(!(!n(Y)&&!r[Y])){continue}Y=x.join(S,Y);if(D.some(function(aa){return aa.indexOf(Y)>=0})){continue}D.push(Y);C.push(null);W.push(f(Y,false,P))}return W})})})}catch(Q){if(Q.code!=="ENOENT"){throw Q}}};H=function(U,R){var S,T,V,P,Q;T=D.slice(0);V=(function(){var W,X,Y;Y=[];for(W=0,X=D.length;W<X;W++){S=D[W];if(S.indexOf(U)>=0){Y.push(S)}}return Y})();for(P=0,Q=V.length;P<Q;P++){S=V[P];B(S,R,true)}if(!D.some(function(X,W){return T[W]!==X})){return}return d()};B=function(T,P,S){var Q,R;Q=D.indexOf(T);D.splice(Q,1);C.splice(Q,1);if(S&&!u.join){R=v(T,P);return x.exists(R,function(U){if(U){return l.unlink(R,function(V){if(V&&V.code!=="ENOENT"){throw V}return G("removed "+T)})}})}};v=function(T,P){var Q,R,S,U;S=x.basename(T,x.extname(T))+".js";U=x.dirname(T);Q=P==="."?U:U.substring(P.length);R=u.output?x.join(u.output,Q):U;return x.join(R,S)};O=function(U,R,P){var Q,S,T;T=v(U,P);S=x.dirname(T);Q=function(){if(R.length<=0){R=" "}return l.writeFile(T,R,function(V){if(V){return y(V.message)}else{if(u.compile&&u.watch){return G("compiled "+U)}}})};return x.exists(S,function(V){if(V){return Q()}else{return j("mkdir -p "+S,Q)}})};K=function(Q,P){return setTimeout(P,Q)};G=function(P){return console.log(""+((new Date).toLocaleTimeString())+" - "+P)};p=function(Q,R){var P,S,T;T=function(U){return y(Q+":\t"+U.toString().trim())};P=__dirname+"/../../extras/jsl.conf";S=E("jsl",["-nologo","-stdin","-conf",P]);S.stdout.on("data",T);S.stderr.on("data",T);S.stdin.write(R);return S.stdin.end()};z=function(S){var P,Q,R,T;P=(function(){var U,V,W,X;X=[];for(U=0,V=S.length;U<V;U++){R=S[U];W=[R[0],R[1].toString().replace(/\n/,"\\n")],Q=W[0],T=W[1];X.push("["+Q+" "+T+"]")}return X})();return y(P.join(" "))};w=function(){var R,S,T,P,Q;s=new t.OptionParser(F,b);S=u=s.parse(process.argv.slice(2));S.compile||(S.compile=!!S.output);S.run=!(S.compile||S.print||S.lint);S.print=!!(S.print||(S["eval"]||S.stdio&&S.compile));D=S["arguments"];for(R=P=0,Q=D.length;P<Q;R=++P){T=D[R];C[R]=null}};e=function(P){return{filename:P,bare:u.bare,header:u.compile}};k=function(){var P,Q;Q=u.nodejs.split(/\s+/);P=process.argv.slice(1);P.splice(P.indexOf("--nodejs"),2);return E(process.execPath,Q.concat(P),{cwd:process.cwd(),env:process.env,customFds:[0,1,2]})};I=function(){return y((new t.OptionParser(F,b)).help())};J=function(){return y("CoffeeScript version "+c.VERSION)}}).call(this);