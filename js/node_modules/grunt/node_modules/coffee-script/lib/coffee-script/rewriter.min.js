(function(){var f,g,h,i,j,k,l,m,n,o,q,s,t,p,r,c,d,e,a=[].indexOf||function(v){for(var u=0,w=this.length;u<w;u++){if(u in this&&this[u]===v){return u}}return -1},b=[].slice;exports.Rewriter=(function(){function u(){}u.prototype.rewrite=function(v){this.tokens=v;this.removeLeadingNewlines();this.removeMidExpressionNewlines();this.closeOpenCalls();this.closeOpenIndexes();this.addImplicitIndentation();this.tagPostfixConditionals();this.addImplicitBraces();this.addImplicitParentheses();return this.tokens};u.prototype.scanTokens=function(v){var w,x,y;y=this.tokens;w=0;while(x=y[w]){w+=v.call(this,x,w,y)}return true};u.prototype.detectEnd=function(z,y,x){var A,B,C,v,w;C=this.tokens;A=0;while(B=C[z]){if(A===0&&y.call(this,B,z)){return x.call(this,B,z)}if(!B||A<0){return x.call(this,B,z-1)}if(v=B[0],a.call(i,v)>=0){A+=1}else{if(w=B[0],a.call(h,w)>=0){A-=1}}z+=1}return z-1};u.prototype.removeLeadingNewlines=function(){var y,z,v,w,x;x=this.tokens;for(y=v=0,w=x.length;v<w;y=++v){z=x[y][0];if(z!=="TERMINATOR"){break}}if(y){return this.tokens.splice(0,y)}};u.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(x,w,y){var v;if(!(x[0]==="TERMINATOR"&&(v=this.tag(w+1),a.call(g,v)>=0))){return 1}y.splice(w,1);return 0})};u.prototype.closeOpenCalls=function(){var v,w;w=function(z,y){var x;return((x=z[0])===")"||x==="CALL_END")||z[0]==="OUTDENT"&&this.tag(y-1)===")"};v=function(y,x){return this.tokens[y[0]==="OUTDENT"?x-1:x][0]="CALL_END"};return this.scanTokens(function(y,x){if(y[0]==="CALL_START"){this.detectEnd(x+1,w,v)}return 1})};u.prototype.closeOpenIndexes=function(){var v,w;w=function(z,y){var x;return(x=z[0])==="]"||x==="INDEX_END"};v=function(y,x){return y[0]="INDEX_END"};return this.scanTokens(function(y,x){if(y[0]==="INDEX_START"){this.detectEnd(x+1,w,v)}return 1})};u.prototype.addImplicitBraces=function(){var v,w,x,y,z,A,B,C;y=[];z=null;C=null;x=true;A=0;B=0;w=function(J,F){var G,H,I,K,D,E;D=this.tokens.slice(F+1,(F+3)+1||9000000000),G=D[0],K=D[1],I=D[2];if("HERECOMMENT"===(G!=null?G[0]:void 0)){return false}H=J[0];if(a.call(q,H)>=0){x=false}return(((H==="TERMINATOR"||H==="OUTDENT")||(a.call(l,H)>=0&&x&&!(F-B===1)))&&((!C&&this.tag(F-1)!==",")||!((K!=null?K[0]:void 0)===":"||(G!=null?G[0]:void 0)==="@"&&(I!=null?I[0]:void 0)===":")))||(H===","&&G&&((E=G[0])!=="IDENTIFIER"&&E!=="NUMBER"&&E!=="STRING"&&E!=="@"&&E!=="TERMINATOR"&&E!=="OUTDENT"))};v=function(F,D){var E;E=this.generate("}","}",F[2]);return this.tokens.splice(D,0,E)};return this.scanTokens(function(L,G,M){var F,H,I,J,K,N,D,E;if(D=(J=L[0]),a.call(i,D)>=0){y.push([(J==="INDENT"&&this.tag(G-1)==="{"?"{":J),G]);return 1}if(a.call(h,J)>=0){z=y.pop();return 1}if(!(J===":"&&((F=this.tag(G-2))===":"||((E=y[y.length-1])!=null?E[0]:void 0)!=="{"))){return 1}x=true;B=G+1;y.push(["{"]);H=F==="@"?G-2:G-1;while(this.tag(H-2)==="HERECOMMENT"){H-=2}I=this.tag(H-1);C=!I||(a.call(q,I)>=0);N=new String("{");N.generated=true;K=this.generate("{",N,L[2]);M.splice(H,0,K);this.detectEnd(G+2,w,v);return 2})};u.prototype.addImplicitParentheses=function(){var v,w,x,y,z;x=z=y=false;w=function(F,C){var D,E,A,B;E=F[0];if(!z&&F.fromThen){return true}if(E==="IF"||E==="ELSE"||E==="CATCH"||E==="->"||E==="=>"||E==="CLASS"){z=true}if(E==="IF"||E==="ELSE"||E==="SWITCH"||E==="TRY"||E==="="){y=true}if((E==="."||E==="?."||E==="::")&&this.tag(C-1)==="OUTDENT"){return true}return !F.generated&&this.tag(C-1)!==","&&(a.call(l,E)>=0||(E==="INDENT"&&!y))&&(E!=="INDENT"||(((A=this.tag(C-2))!=="CLASS"&&A!=="EXTENDS")&&(B=this.tag(C-1),a.call(j,B)<0)&&!((D=this.tokens[C+1])&&D.generated&&D[0]==="{")))};v=function(B,A){return this.tokens.splice(A,0,this.generate("CALL_END",")",B[2]))};return this.scanTokens(function(J,F,K){var D,E,G,H,I,A,B,C;I=J[0];if(I==="CLASS"||I==="IF"||I==="FOR"||I==="WHILE"){x=true}A=K.slice(F-1,(F+1)+1||9000000000),H=A[0],E=A[1],G=A[2];D=!x&&I==="INDENT"&&G&&G.generated&&G[0]==="{"&&H&&(B=H[0],a.call(m,B)>=0);z=false;y=false;if(a.call(q,I)>=0){x=false}if(H&&!H.spaced&&I==="?"){J.call=true}if(J.fromThen){return 1}if(!(D||(H!=null?H.spaced:void 0)&&(H.call||(C=H[0],a.call(m,C)>=0))&&(a.call(k,I)>=0||!(J.spaced||J.newLine)&&a.call(n,I)>=0))){return 1}K.splice(F,0,this.generate("CALL_START","(",J[2]));this.detectEnd(F+1,w,v);if(H[0]==="?"){H[0]="FUNC_EXIST"}return 2})};u.prototype.addImplicitIndentation=function(){var v,w,x,y,z;z=x=y=null;w=function(C,B){var A;return C[1]!==";"&&(A=C[0],a.call(s,A)>=0)&&!(C[0]==="ELSE"&&(z!=="IF"&&z!=="THEN"))};v=function(B,A){return this.tokens.splice((this.tag(A-1)===","?A-1:A),0,y)};return this.scanTokens(function(E,C,F){var D,A,B;D=E[0];if(D==="TERMINATOR"&&this.tag(C+1)==="THEN"){F.splice(C,1);return 0}if(D==="ELSE"&&this.tag(C-1)!=="OUTDENT"){F.splice.apply(F,[C,0].concat(b.call(this.indentation(E))));return 2}if(D==="CATCH"&&((A=this.tag(C+2))==="OUTDENT"||A==="TERMINATOR"||A==="FINALLY")){F.splice.apply(F,[C+2,0].concat(b.call(this.indentation(E))));return 4}if(a.call(t,D)>=0&&this.tag(C+1)!=="INDENT"&&!(D==="ELSE"&&this.tag(C+1)==="IF")){z=D;B=this.indentation(E,true),x=B[0],y=B[1];if(z==="THEN"){x.fromThen=true}F.splice(C+1,0,x);this.detectEnd(C+2,w,v);if(D==="THEN"){F.splice(C,1)}return 1}return 1})};u.prototype.tagPostfixConditionals=function(){var v,w,x;x=null;w=function(A,z){var y;return(y=A[0])==="TERMINATOR"||y==="INDENT"};v=function(z,y){if(z[0]!=="INDENT"||(z.generated&&!z.fromThen)){return x[0]="POST_"+x[0]}};return this.scanTokens(function(z,y){if(z[0]!=="IF"){return 1}x=z;this.detectEnd(y+1,w,v);return 1})};u.prototype.indentation=function(y,v){var w,x;if(v==null){v=false}w=["INDENT",2,y[2]];x=["OUTDENT",2,y[2]];if(v){w.generated=x.generated=true}return[w,x]};u.prototype.generate=function(w,y,v){var x;x=[w,y,v];x.generated=true;return x};u.prototype.tag=function(w){var v;return(v=this.tokens[w])!=null?v[0]:void 0};return u})();f=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]];exports.INVERSES=o={};i=[];h=[];for(c=0,d=f.length;c<d;c++){e=f[c],p=e[0],r=e[1];i.push(o[r]=p);h.push(o[p]=r)}g=["CATCH","WHEN","ELSE","FINALLY"].concat(h);m=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"];k=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","@","->","=>","[","(","{","--","++"];n=["+","-"];j=["->","=>","{","[",","];l=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"];t=["ELSE","->","=>","TRY","FINALLY","THEN"];s=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"];q=["TERMINATOR","INDENT","OUTDENT"]}).call(this);