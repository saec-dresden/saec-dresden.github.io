(function(){var d,e,f,h,g,i,j,l,m,o,p,q,r,s,t,u,v,y,w,x,C,D,E,B,F,H,G,I,J,K,L,M,N,O,P,Q,R,T,U,V,W,k,n,z,A,S,b,c,a=[].indexOf||function(Y){for(var X=0,Z=this.length;X<Z;X++){if(X in this&&this[X]===Y){return X}}return -1};b=require("./rewriter"),P=b.Rewriter,v=b.INVERSES;c=require("./helpers"),n=c.count,S=c.starts,k=c.compact,A=c.last;exports.Lexer=B=(function(){function X(){}X.prototype.tokenize=function(Y,aa){var Z,ab;if(aa==null){aa={}}if(W.test(Y)){Y="\n"+Y}Y=Y.replace(/\r/g,"").replace(U,"");this.code=Y;this.line=aa.line||0;this.indent=0;this.indebt=0;this.outdebt=0;this.indents=[];this.ends=[];this.tokens=[];Z=0;while(this.chunk=Y.slice(Z)){Z+=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken()}this.closeIndentation();if(ab=this.ends.pop()){this.error("missing "+ab)}if(aa.rewrite===false){return this.tokens}return(new P).rewrite(this.tokens)};X.prototype.identifierToken=function(){var aa,ab,ac,ad,ae,af,ag,Y,Z;if(!(ae=t.exec(this.chunk))){return 0}ad=ae[0],ac=ae[1],aa=ae[2];if(ac==="own"&&this.tag()==="FOR"){this.token("OWN",ac);return ac.length}ab=aa||(af=A(this.tokens))&&(((Y=af[0])==="."||Y==="?."||Y==="::")||!af.spaced&&af[0]==="@");ag="IDENTIFIER";if(!ab&&(a.call(x,ac)>=0||a.call(i,ac)>=0)){ag=ac.toUpperCase();if(ag==="WHEN"&&(Z=this.tag(),a.call(C,Z)>=0)){ag="LEADING_WHEN"}else{if(ag==="FOR"){this.seenFor=true}else{if(ag==="UNLESS"){ag="IF"}else{if(a.call(V,ag)>=0){ag="UNARY"}else{if(a.call(N,ag)>=0){if(ag!=="INSTANCEOF"&&this.seenFor){ag="FOR"+ag;this.seenFor=false}else{ag="RELATION";if(this.value()==="!"){this.tokens.pop();ac="!"+ac}}}}}}}}if(a.call(w,ac)>=0){if(ab){ag="IDENTIFIER";ac=new String(ac);ac.reserved=true}else{if(a.call(O,ac)>=0){this.error('reserved word "'+ac+'"')}}}if(!ab){if(a.call(h,ac)>=0){ac=g[ac]}ag=(function(){switch(ac){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return ag}})()}this.token(ag,ac);if(aa){this.token(":",":")}return ad.length};X.prototype.numberToken=function(){var Y,Z,aa,ab,ac;if(!(aa=K.exec(this.chunk))){return 0}ab=aa[0];if(/^0[BOX]/.test(ab)){this.error("radix prefix '"+ab+"' must be lowercase")}else{if(/E/.test(ab)&&!/^0x/.test(ab)){this.error("exponential notation '"+ab+"' must be indicated with a lowercase 'e'")}else{if(/^0\d*[89]/.test(ab)){this.error("decimal literal '"+ab+"' must not be prefixed with '0'")}else{if(/^0\d+/.test(ab)){this.error("octal literal '"+ab+"' must be prefixed with '0o'")}}}}Z=ab.length;if(ac=/^0o([0-7]+)/.exec(ab)){ab="0x"+(parseInt(ac[1],8)).toString(16)}if(Y=/^0b([01]+)/.exec(ab)){ab="0x"+(parseInt(Y[1],2)).toString(16)}this.token("NUMBER",ab);return Z};X.prototype.stringToken=function(){var Y,Z,aa;switch(this.chunk.charAt(0)){case"'":if(!(Y=R.exec(this.chunk))){return 0}this.token("STRING",(aa=Y[0]).replace(H,"\\\n"));break;case'"':if(!(aa=this.balancedString(this.chunk,'"'))){return 0}if(0<aa.indexOf("#{",1)){this.interpolateString(aa.slice(1,-1))}else{this.token("STRING",this.escapeLines(aa))}break;default:return 0}if(Z=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(aa)){this.error("octal escape sequences "+aa+" are not allowed")}this.line+=n(aa,"\n");return aa.length};X.prototype.heredocToken=function(){var Y,Z,aa,ab;if(!(aa=o.exec(this.chunk))){return 0}Z=aa[0];ab=Z.charAt(0);Y=this.sanitizeHeredoc(aa[2],{quote:ab,indent:null});if(ab==='"'&&0<=Y.indexOf("#{")){this.interpolateString(Y,{heredoc:true})}else{this.token("STRING",this.makeString(Y,ab,true))}this.line+=n(Z,"\n");return Z.length};X.prototype.commentToken=function(){var Y,Z,aa;if(!(aa=this.chunk.match(j))){return 0}Y=aa[0],Z=aa[1];if(Z){this.token("HERECOMMENT",this.sanitizeHeredoc(Z,{herecomment:true,indent:Array(this.indent+1).join(" ")}))}this.line+=n(Y,"\n");return Y.length};X.prototype.jsToken=function(){var Y,Z;if(!(this.chunk.charAt(0)==="`"&&(Y=y.exec(this.chunk)))){return 0}this.token("JS",(Z=Y[0]).slice(1,-1));return Z.length};X.prototype.regexToken=function(){var aa,ab,ac,ad,ae,Y,Z;if(this.chunk.charAt(0)!=="/"){return 0}if(ac=r.exec(this.chunk)){ab=this.heregexToken(ac);this.line+=n(ac[0],"\n");return ab}ad=A(this.tokens);if(ad&&(Y=ad[0],a.call((ad.spaced?I:J),Y)>=0)){return 0}if(!(ac=M.exec(this.chunk))){return 0}Z=ac,ac=Z[0],ae=Z[1],aa=Z[2];if(ae.slice(0,2)==="/*"){this.error("regular expressions cannot begin with `*`")}if(ae==="//"){ae="/(?:)/"}this.token("REGEX",""+ae+aa);return ac.length};X.prototype.heregexToken=function(ah){var ae,af,ag,ai,aj,ak,al,Y,Z,aa,ab,ac,ad;ag=ah[0],ae=ah[1],af=ah[2];if(0>ae.indexOf("#{")){ai=ae.replace(s,"").replace(/\//g,"\\/");if(ai.match(/^\*/)){this.error("regular expressions cannot begin with `*`")}this.token("REGEX","/"+(ai||"(?:)")+"/"+af);return ag.length}this.token("IDENTIFIER","RegExp");this.tokens.push(["CALL_START","("]);ak=[];aa=this.interpolateString(ae,{regex:true});for(Y=0,Z=aa.length;Y<Z;Y++){ab=aa[Y],aj=ab[0],al=ab[1];if(aj==="TOKENS"){ak.push.apply(ak,al)}else{if(!(al=al.replace(s,""))){continue}al=al.replace(/\\/g,"\\\\");ak.push(["STRING",this.makeString(al,'"',true)])}ak.push(["+","+"])}ak.pop();if(((ac=ak[0])!=null?ac[0]:void 0)!=="STRING"){this.tokens.push(["STRING",'""'],["+","+"])}(ad=this.tokens).push.apply(ad,ak);if(af){this.tokens.push([",",","],["STRING",'"'+af+'"'])}this.token(")",")");return ag.length};X.prototype.lineToken=function(){var Y,Z,aa,ab,ac,ad;if(!(aa=G.exec(this.chunk))){return 0}Z=aa[0];this.line+=n(Z,"\n");this.seenFor=false;ac=A(this.tokens,1);ad=Z.length-1-Z.lastIndexOf("\n");ab=this.unfinished();if(ad-this.indebt===this.indent){if(ab){this.suppressNewlines()}else{this.newlineToken()}return Z.length}if(ad>this.indent){if(ab){this.indebt=ad-this.indent;this.suppressNewlines();return Z.length}Y=ad-this.indent+this.outdebt;this.token("INDENT",Y);this.indents.push(Y);this.ends.push("OUTDENT");this.outdebt=this.indebt=0}else{this.indebt=0;this.outdentToken(this.indent-ad,ab)}this.indent=ad;return Z.length};X.prototype.outdentToken=function(aa,ab){var Y,Z;while(aa>0){Z=this.indents.length-1;if(this.indents[Z]===void 0){aa=0}else{if(this.indents[Z]===this.outdebt){aa-=this.outdebt;this.outdebt=0}else{if(this.indents[Z]<this.outdebt){this.outdebt-=this.indents[Z];aa-=this.indents[Z]}else{Y=this.indents.pop()-this.outdebt;aa-=Y;this.outdebt=0;this.pair("OUTDENT");this.token("OUTDENT",Y)}}}}if(Y){this.outdebt-=aa}while(this.value()===";"){this.tokens.pop()}if(!(this.tag()==="TERMINATOR"||ab)){this.token("TERMINATOR","\n")}return this};X.prototype.whitespaceToken=function(){var Y,Z,aa;if(!((Y=W.exec(this.chunk))||(Z=this.chunk.charAt(0)==="\n"))){return 0}aa=A(this.tokens);if(aa){aa[Y?"spaced":"newLine"]=true}if(Y){return Y[0].length}else{return 0}};X.prototype.newlineToken=function(){while(this.value()===";"){this.tokens.pop()}if(this.tag()!=="TERMINATOR"){this.token("TERMINATOR","\n")}return this};X.prototype.suppressNewlines=function(){if(this.value()==="\\"){this.tokens.pop()}return this};X.prototype.literalToken=function(){var ac,ad,ae,af,Y,Z,aa,ab;if(ac=L.exec(this.chunk)){af=ac[0];if(f.test(af)){this.tagParameters()}}else{af=this.chunk.charAt(0)}ae=af;ad=A(this.tokens);if(af==="="&&ad){if(!ad[1].reserved&&(Y=ad[1],a.call(w,Y)>=0)){this.error('reserved word "'+(this.value())+"\" can't be assigned")}if((Z=ad[1])==="||"||Z==="&&"){ad[0]="COMPOUND_ASSIGN";ad[1]+="=";return af.length}}if(af===";"){this.seenFor=false;ae="TERMINATOR"}else{if(a.call(F,af)>=0){ae="MATH"}else{if(a.call(l,af)>=0){ae="COMPARE"}else{if(a.call(m,af)>=0){ae="COMPOUND_ASSIGN"}else{if(a.call(V,af)>=0){ae="UNARY"}else{if(a.call(Q,af)>=0){ae="SHIFT"}else{if(a.call(E,af)>=0||af==="?"&&(ad!=null?ad.spaced:void 0)){ae="LOGIC"}else{if(ad&&!ad.spaced){if(af==="("&&(aa=ad[0],a.call(e,aa)>=0)){if(ad[0]==="?"){ad[0]="FUNC_EXIST"}ae="CALL_START"}else{if(af==="["&&(ab=ad[0],a.call(u,ab)>=0)){ae="INDEX_START";switch(ad[0]){case"?":ad[0]="INDEX_SOAK"}}}}}}}}}}}switch(af){case"(":case"{":case"[":this.ends.push(v[af]);break;case")":case"}":case"]":this.pair(af)}this.token(ae,af);return af.length};X.prototype.sanitizeHeredoc=function(aa,ae){var Z,ab,ac,ad,Y;ac=ae.indent,ab=ae.herecomment;if(ab){if(p.test(aa)){this.error('block comment cannot contain "*/", starting')}if(aa.indexOf("\n")<=0){return aa}}else{while(ad=q.exec(aa)){Z=ad[1];if(ac===null||(0<(Y=Z.length)&&Y<ac.length)){ac=Z}}}if(ac){aa=aa.replace(RegExp("\\n"+ac,"g"),"\n")}if(!ab){aa=aa.replace(/^\n/,"")}return aa};X.prototype.tagParameters=function(){var Y,Z,aa,ab;if(this.tag()!==")"){return this}Z=[];ab=this.tokens;Y=ab.length;ab[--Y][0]="PARAM_END";while(aa=ab[--Y]){switch(aa[0]){case")":Z.push(aa);break;case"(":case"CALL_START":if(Z.length){Z.pop()}else{if(aa[0]==="("){aa[0]="PARAM_START";return this}else{return this}}}}return this};X.prototype.closeIndentation=function(){return this.outdentToken(this.indent)};X.prototype.balancedString=function(ah,ab){var aa,ac,ad,ae,af,ag,Y,Z;aa=0;ag=[ab];for(ac=Y=1,Z=ah.length;1<=Z?Y<Z:Y>Z;ac=1<=Z?++Y:--Y){if(aa){--aa;continue}switch(ad=ah.charAt(ac)){case"\\":++aa;continue;case ab:ag.pop();if(!ag.length){return ah.slice(0,ac+1||9000000000)}ab=ag[ag.length-1];continue}if(ab==="}"&&(ad==='"'||ad==="'")){ag.push(ab=ad)}else{if(ab==="}"&&ad==="/"&&(ae=r.exec(ah.slice(ac))||M.exec(ah.slice(ac)))){aa+=ae[0].length-1}else{if(ab==="}"&&ad==="{"){ag.push(ab="}")}else{if(ab==='"'&&af==="#"&&ad==="{"){ag.push(ab="}")}}}}af=ad}return this.error("missing "+(ag.pop())+", starting")};X.prototype.interpolateString=function(ao,al){var ad,ae,af,ag,ah,ai,aj,ak,am,an,ap,aq,ar,Y,Z,aa,ab,ac;if(al==null){al={}}ae=al.heredoc,an=al.regex;aq=[];am=0;af=-1;while(aj=ao.charAt(af+=1)){if(aj==="\\"){af+=1;continue}if(!(aj==="#"&&ao.charAt(af+1)==="{"&&(ad=this.balancedString(ao.slice(af+1),"}")))){continue}if(am<af){aq.push(["NEOSTRING",ao.slice(am,af)])}ag=ad.slice(1,-1);if(ag.length){ak=new X().tokenize(ag,{line:this.line,rewrite:false});ak.pop();if(((aa=ak[0])!=null?aa[0]:void 0)==="TERMINATOR"){ak.shift()}if(ai=ak.length){if(ai>1){ak.unshift(["(","(",this.line]);ak.push([")",")",this.line])}aq.push(["TOKENS",ak])}}af+=ad.length;am=af+1}if((af>am&&am<ao.length)){aq.push(["NEOSTRING",ao.slice(am)])}if(an){return aq}if(!aq.length){return this.token("STRING",'""')}if(aq[0][0]!=="NEOSTRING"){aq.unshift(["",""])}if(ah=aq.length>1){this.token("(","(")}for(af=Y=0,Z=aq.length;Y<Z;af=++Y){ab=aq[af],ap=ab[0],ar=ab[1];if(af){this.token("+","+")}if(ap==="TOKENS"){(ac=this.tokens).push.apply(ac,ar)}else{this.token("STRING",this.makeString(ar,'"',ae))}}if(ah){this.token(")",")")}return aq};X.prototype.pair=function(Z){var Y,aa;if(Z!==(aa=A(this.ends))){if("OUTDENT"!==aa){this.error("unmatched "+Z)}this.indent-=Y=A(this.indents);this.outdentToken(Y,true);return this.pair(Z)}return this.ends.pop()};X.prototype.token=function(Y,Z){return this.tokens.push([Y,Z,this.line])};X.prototype.tag=function(Y,Z){var aa;return(aa=A(this.tokens,Y))&&(Z?aa[0]=Z:aa[0])};X.prototype.value=function(Y,aa){var Z;return(Z=A(this.tokens,Y))&&(aa?Z[1]=aa:Z[1])};X.prototype.unfinished=function(){var Y;return D.test(this.chunk)||((Y=this.tag())==="\\"||Y==="."||Y==="?."||Y==="UNARY"||Y==="MATH"||Y==="+"||Y==="-"||Y==="SHIFT"||Y==="RELATION"||Y==="COMPARE"||Y==="LOGIC"||Y==="THROW"||Y==="EXTENDS")};X.prototype.escapeLines=function(Z,Y){return Z.replace(H,Y?"\\n":"")};X.prototype.makeString=function(Y,aa,Z){if(!Y){return aa+aa}Y=Y.replace(/\\([\s\S])/g,function(ac,ab){if(ab==="\n"||ab===aa){return ab}else{return ac}});Y=Y.replace(RegExp(""+aa,"g"),"\\$&");return aa+this.escapeLines(Y,Z)+aa};X.prototype.error=function(Y){throw SyntaxError(""+Y+" on line "+(this.line+1))};return X})();x=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"];i=["undefined","then","unless","until","loop","of","by","when"];g={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"};h=(function(){var X;X=[];for(z in g){X.push(z)}return X})();i=i.concat(h);O=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","let","package","private","protected","public","static","yield"];T=["arguments","eval"];w=x.concat(O).concat(T);exports.RESERVED=O.concat(x).concat(i).concat(T);exports.STRICT_PROSCRIBED=T;t=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/;K=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i;o=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/;L=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?\.|\.{2,3})/;W=/^[^\n\S]+/;j=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)?$)|^(?:\s*#(?!##[^#]).*)+/;f=/^[-=]>/;G=/^(?:\n[^\n\S]*)+/;R=/^'[^\\']*(?:\\.[^\\']*)*'/;y=/^`[^\\`]*(?:\\.[^\\`]*)*`/;M=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/;r=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/;s=/\s+(?:#.*)?/g;H=/\n/g;q=/\n+([^\n\S]*)/g;p=/\*\//;D=/^\s*(?:,|\??\.(?![.\d])|::)/;U=/\s+$/;m=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="];V=["!","~","NEW","TYPEOF","DELETE","DO"];E=["&&","||","&","|","^"];Q=["<<",">>",">>>"];l=["==","!=","<",">","<=",">="];F=["*","/","%"];N=["IN","OF","INSTANCEOF"];d=["TRUE","FALSE"];I=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--","]"];J=I.concat(")","}","THIS","IDENTIFIER","STRING");e=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"];u=e.concat("NUMBER","BOOL","NULL","UNDEFINED");C=["INDENT","OUTDENT","TERMINATOR"]}).call(this);