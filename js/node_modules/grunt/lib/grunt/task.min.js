"use strict";var grunt=require("../grunt");var path=require("path");var parent=grunt.util.task.create();var task=module.exports=Object.create(parent);var registry={tasks:[],untasks:[],meta:{}};var lastInfo;var loadTaskDepth=0;var errorcount;task.registerTask=function(b){registry.tasks.push(b);parent.registerTask.apply(task,arguments);var c=task._tasks[b];c.meta=grunt.util._.clone(registry.meta);var a=c.fn;c.fn=function(d){var f=c.name;errorcount=grunt.fail.errorcount;Object.defineProperty(this,"errorCount",{enumerable:true,get:function(){return grunt.fail.errorcount-errorcount}});this.requires=task.requires.bind(task);this.requiresConfig=grunt.config.requires;this.options=function(){var g=[{}].concat(grunt.util.toArray(arguments)).concat([grunt.config([f,"options"])]);var h=grunt.util._.extend.apply(null,g);grunt.verbose.writeflags(h,"Options");return h};var e=a.alias||(c.multi&&(!d||d==="*"))?"verbose":"log";grunt[e].header('Running "'+this.nameArgs+'"'+(this.name!==this.nameArgs?" ("+this.name+")":"")+" task");grunt[e].debug("Task source: "+c.meta.filepath);return a.apply(this,arguments)};return task};function isValidMultiTaskTarget(a){return !/^_|^options$/.test(a)}task.normalizeMultiTaskFiles=function(a,e){var d,c;var b=[];if(grunt.util.kindOf(a)==="object"){if("src" in a||"dest" in a){c={};for(d in a){if(d!=="options"){c[d]=a[d]}}b.push(c)}else{if(grunt.util.kindOf(a.files)==="object"){for(d in a.files){b.push({src:a.files[d],dest:grunt.config.process(d)})}}else{if(Array.isArray(a.files)){grunt.util._.flatten(a.files).forEach(function(f){var g;if("src" in f||"dest" in f){b.push(f)}else{for(g in f){b.push({src:f[g],dest:grunt.config.process(g)})}}})}}}}else{b.push({src:a,dest:grunt.config.process(e)})}if(b.length===0){grunt.verbose.writeln("File: "+"[no files]".yellow);return[]}b=grunt.util._(b).chain().forEach(function(f){if(!("src" in f)||!f.src){return}if(Array.isArray(f.src)){f.src=grunt.util._.flatten(f.src)}else{f.src=[f.src]}}).map(function(h){var f=grunt.util._.extend({},h);delete f.src;delete f.dest;if(h.expand){return grunt.file.expandMapping(h.src,h.dest,f).map(function(j){var k=grunt.util._.extend({},h);k.orig=grunt.util._.extend({},h);k.src=grunt.config.process(j.src);k.dest=grunt.config.process(j.dest);["expand","cwd","flatten","rename","ext"].forEach(function(l){delete k[l]});return k})}var i=grunt.util._.extend({},h);i.orig=grunt.util._.extend({},h);if("src" in i){Object.defineProperty(i,"src",{enumerable:true,get:function g(){var j;if(!("result" in g)){j=h.src;j=Array.isArray(j)?grunt.util._.flatten(j):[j];g.result=grunt.file.expand(f,j)}return g.result}})}if("dest" in i){i.dest=h.dest}return i}).flatten().value();if(grunt.option("verbose")){b.forEach(function(f){var g=[];if("src" in f){g.push(f.src.length>0?grunt.log.wordlist(f.src):"[no src]".yellow)}if("dest" in f){g.push("-> "+(f.dest?String(f.dest).cyan:"[no dest]".yellow))}if(g.length>0){grunt.verbose.writeln("Files: "+g.join(" "))}})}return b};task.registerMultiTask=function(c,b,a){if(a==null){a=b;b="Custom multi task."}var d;task.registerTask(c,b,function(f){var e=d.name;this.args=grunt.util.toArray(arguments).slice(1);if(!f||f==="*"){return task.runAllTargets(e,this.args)}else{if(!isValidMultiTaskTarget(f)){throw new Error('Invalid target "'+f+'" specified.')}}this.requiresConfig([e,f]);this.options=function(){var i=grunt.config([e,f]);var g=[{}].concat(grunt.util.toArray(arguments)).concat([grunt.config([e,"options"]),grunt.util.kindOf(i)==="object"?i.options:{}]);var h=grunt.util._.extend.apply(null,g);grunt.verbose.writeflags(h,"Options");return h};this.target=f;this.flags={};this.args.forEach(function(g){this.flags[g]=true},this);this.data=grunt.config([e,f]);this.files=task.normalizeMultiTaskFiles(this.data,f);Object.defineProperty(this,"filesSrc",{enumerable:true,get:function(){return grunt.util._(this.files).chain().pluck("src").flatten().uniq().value()}.bind(this)});return a.apply(this,this.args)});d=task._tasks[c];d.multi=true};task.registerInitTask=function(c,b,a){task.registerTask(c,b,a);task._tasks[c].init=true};task.renameTask=function(c,b){var d;try{d=parent.renameTask.apply(task,arguments);registry.untasks.push(c);registry.tasks.push(b);return d}catch(a){grunt.log.error(a.message)}};task.runAllTargets=function(c,a){var b=Object.keys(grunt.config.getRaw(c)||{});if(b.length===0){grunt.log.error('No "'+c+'" targets found.');return false}b.filter(isValidMultiTaskTarget).forEach(function(d){task.run([c,d].concat(a||[]).join(":"))})};var loadTaskStack=[];function loadTask(c){loadTaskStack.push(registry);registry={tasks:[],untasks:[],meta:{info:lastInfo,filepath:c}};var b=path.basename(c);var f='Loading "'+b+'" tasks...';var g=0;var d;try{d=require(path.resolve(c));if(typeof d==="function"){d.call(grunt,grunt)}grunt.verbose.write(f).ok();["un",""].forEach(function(h){var e=grunt.util._.chain(registry[h+"tasks"]).uniq().sort().value();if(e.length>0){g++;grunt.verbose.writeln((h?"- ":"+ ")+grunt.log.wordlist(e))}});if(g===0){grunt.verbose.warn("No tasks were registered or unregistered.")}}catch(a){grunt.log.write(f).error().verbose.error(a.stack).or.error(a)}registry=loadTaskStack.pop()||{}}function loadTasksMessage(a){if(loadTaskDepth===0){lastInfo=a}grunt.verbose.subhead("Registering "+a+" tasks.")}function loadTasks(c){try{var b=grunt.file.glob.sync("*.{js,coffee}",{cwd:c,maxDepth:1});b.forEach(function(d){loadTask(path.join(c,d))})}catch(a){grunt.log.verbose.error(a.stack).or.error(a)}}task.loadTasks=function(a){loadTasksMessage('"'+a+'"');if(grunt.file.exists(a)){loadTasks(a)}else{grunt.log.error('Tasks directory "'+a+'" not found.')}};task.loadNpmTasks=function(a){loadTasksMessage('"'+a+'" local Npm module');var d=path.resolve("node_modules");var c=path.join(d,a,"package.json");var b=grunt.file.exists(c)?grunt.file.readJSON(c):{keywords:[]};if(b.keywords&&b.keywords.indexOf("gruntcollection")!==-1){loadTaskDepth++;Object.keys(b.dependencies).forEach(function(f){var g=grunt.file.findup("node_modules/"+f,{cwd:path.resolve("node_modules",a),nocase:true});if(g){task.loadNpmTasks(path.relative(d,g))}});loadTaskDepth--;return}var e=path.join(d,a,"tasks");if(grunt.file.exists(e)){loadTasks(e)}else{grunt.log.error('Local Npm module "'+a+'" not found. Is it installed?')}};task.init=function(e,d){if(!d){d={}}var a=e.length>0&&e.every(function(f){var g=task._taskPlusArgs(f).task;return g&&g.init});var b=a?null:grunt.option("gruntfile")||grunt.file.findup("Gruntfile.{js,coffee}",{nocase:true});var c='Reading "'+(b?path.basename(b):"???")+'" Gruntfile...';if(b&&grunt.file.exists(b)){grunt.verbose.writeln().write(c).ok();process.chdir(grunt.option("base")||path.dirname(b));loadTasksMessage("Gruntfile");loadTask(b)}else{if(d.help||a){}else{if(grunt.option("gruntfile")){grunt.log.writeln().write(c).error();grunt.fatal('Unable to find "'+b+'" Gruntfile.',grunt.fail.code.MISSING_GRUNTFILE)}else{if(!grunt.option("help")){grunt.verbose.writeln().write(c).error();grunt.log.writelns("A valid Gruntfile could not be found. Please see the getting started guide for more information on how to configure grunt: http://gruntjs.com/getting-started");grunt.fatal("Unable to find Gruntfile.",grunt.fail.code.MISSING_GRUNTFILE)}}}}(grunt.option("npm")||[]).forEach(task.loadNpmTasks);(grunt.option("tasks")||[]).forEach(task.loadTasks)};